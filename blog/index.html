<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-alpha.75">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="KubeVela Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="KubeVela Blog Atom Feed">
<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-5GLR1Y52M7"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-5GLR1Y52M7",{})</script>
<link rel="search" type="application/opensearchdescription+xml" title="KubeVela" href="/opensearch.xml"><title data-react-helmet="true">Blog | KubeVela</title><meta data-react-helmet="true" property="og:title" content="Blog | KubeVela"><meta data-react-helmet="true" name="description" content="Blog"><meta data-react-helmet="true" property="og:description" content="Blog"><meta data-react-helmet="true" property="og:url" content="https://kubevela.io/blog"><meta data-react-helmet="true" name="docsearch:language" content="en"><meta data-react-helmet="true" name="docsearch:docusaurus_tag" content="blog_posts_list"><meta data-react-helmet="true" property="og:image" content="https://tva1.sinaimg.cn/large/ad5fbf65gy1glgj5q8inej208g049aa6.jpg"><meta data-react-helmet="true" name="twitter:image" content="https://tva1.sinaimg.cn/large/ad5fbf65gy1glgj5q8inej208g049aa6.jpg"><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://kubevela.io/blog"><link data-react-helmet="true" rel="alternate" href="https://kubevela.io/blog" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://kubevela.io/zh/blog" hreflang="zh"><link data-react-helmet="true" rel="alternate" href="https://kubevela.io/blog" hreflang="x-default"><link data-react-helmet="true" rel="preconnect" href="https://BH4D9OD16A-dsn.algolia.net" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/styles.1f84ae86.css">
<link rel="preload" href="/assets/js/runtime~main.95f7c22f.js" as="script">
<link rel="preload" href="/assets/js/main.a6060325.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#main" class="skipToContent_1oUP">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle" type="button" tabindex="0"><svg aria-label="Menu" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><img src="/img/logo.svg" alt="KubeVela" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/img/logoDark.svg" alt="KubeVela" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"><strong class="navbar__title">KubeVela</strong></a><a class="navbar__item navbar__link" href="/docs/">Documentation</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/blog">Blog</a></div><div class="navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a class="navbar__item navbar__link" href="/docs/">v1.3</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/docs/next/">Next</a></li><li><a class="dropdown__link" href="/docs/">v1.3</a></li><li><a class="dropdown__link" href="/docs/v1.2/">v1.2</a></li><li><a class="dropdown__link" href="/docs/v1.1/">v1.1</a></li><li><a class="dropdown__link" href="/docs/v1.0/">v1.0</a></li></ul></div><a href="https://kubevela.net" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Mirror</a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" class="navbar__item navbar__link"><span><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" width="20" height="20" style="vertical-align:text-bottom;margin-right:5px"><path fill="currentColor" d="M19.753 10.909c-.624-1.707-2.366-2.726-4.661-2.726-.09 0-.176.002-.262.006l-.016-2.063 3.525-.607c.115-.019.133-.119.109-.231-.023-.111-.167-.883-.188-.976-.027-.131-.102-.127-.207-.109-.104.018-3.25.461-3.25.461l-.013-2.078c-.001-.125-.069-.158-.194-.156l-1.025.016c-.105.002-.164.049-.162.148l.033 2.307s-3.061.527-3.144.543c-.084.014-.17.053-.151.143.019.09.19 1.094.208 1.172.018.08.072.129.188.107l2.924-.504.035 2.018c-1.077.281-1.801.824-2.256 1.303-.768.807-1.207 1.887-1.207 2.963 0 1.586.971 2.529 2.328 2.695 3.162.387 5.119-3.06 5.769-4.715 1.097 1.506.256 4.354-2.094 5.98-.043.029-.098.129-.033.207l.619.756c.08.096.206.059.256.023 2.51-1.73 3.661-4.515 2.869-6.683zm-7.386 3.188c-.966-.121-.944-.914-.944-1.453 0-.773.327-1.58.876-2.156a3.21 3.21 0 011.229-.799l.082 4.277a2.773 2.773 0 01-1.243.131zm2.427-.553l.046-4.109c.084-.004.166-.01.252-.01.773 0 1.494.145 1.885.361.391.217-1.023 2.713-2.183 3.758zm-8.95-7.668a.196.196 0 00-.196-.145h-1.95a.194.194 0 00-.194.144L.008 16.916c-.017.051-.011.076.062.076h1.733c.075 0 .099-.023.114-.072l1.008-3.318h3.496l1.008 3.318c.016.049.039.072.113.072h1.734c.072 0 .078-.025.062-.076-.014-.05-3.083-9.741-3.494-11.04zm-2.618 6.318l1.447-5.25 1.447 5.25H3.226z"></path></svg><span>English</span></span></a><ul class="dropdown__menu"><li><a href="/blog" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active" style="text-transform:capitalize">English</a></li><li><a href="/zh/blog" target="_self" rel="noopener noreferrer" class="dropdown__link" style="text-transform:capitalize">ç®€ä½“ä¸­æ–‡</a></li></ul></div><a href="https://github.com/oam-dev/kubevela" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-github-link"></a><div class="react-toggle displayOnlyInLargeViewport_GrZ2 react-toggle--disabled" role="button" tabindex="-1"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_71bT">ðŸŒœ</span></div><div class="react-toggle-track-x"><span class="toggle_71bT">ðŸŒž</span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" class="react-toggle-screenreader-only" aria-label="Switch between dark and light mode"></div><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span></button></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/"><img src="/img/logo.svg" alt="KubeVela" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/img/logoDark.svg" alt="KubeVela" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"><strong class="navbar__title">KubeVela</strong></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item menu__list-item--collapsed"><a role="button" class="menu__link menu__link--sublist">Versions</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/docs/next/">Next</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/">v1.3</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/v1.2/">v1.2</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/v1.1/">v1.1</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/v1.0/">v1.0</a></li></ul></li><li class="menu__list-item"><a class="menu__link" href="/docs/">Documentation</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link navbar__link--active" href="/blog">Blog</a></li><li class="menu__list-item"><a href="https://kubevela.net" target="_blank" rel="noopener noreferrer" class="menu__link">Mirror</a></li><li class="menu__list-item menu__list-item--collapsed"><a href="#" role="button" class="menu__link menu__link--sublist"><span><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" width="20" height="20" style="vertical-align:text-bottom;margin-right:5px"><path fill="currentColor" d="M19.753 10.909c-.624-1.707-2.366-2.726-4.661-2.726-.09 0-.176.002-.262.006l-.016-2.063 3.525-.607c.115-.019.133-.119.109-.231-.023-.111-.167-.883-.188-.976-.027-.131-.102-.127-.207-.109-.104.018-3.25.461-3.25.461l-.013-2.078c-.001-.125-.069-.158-.194-.156l-1.025.016c-.105.002-.164.049-.162.148l.033 2.307s-3.061.527-3.144.543c-.084.014-.17.053-.151.143.019.09.19 1.094.208 1.172.018.08.072.129.188.107l2.924-.504.035 2.018c-1.077.281-1.801.824-2.256 1.303-.768.807-1.207 1.887-1.207 2.963 0 1.586.971 2.529 2.328 2.695 3.162.387 5.119-3.06 5.769-4.715 1.097 1.506.256 4.354-2.094 5.98-.043.029-.098.129-.033.207l.619.756c.08.096.206.059.256.023 2.51-1.73 3.661-4.515 2.869-6.683zm-7.386 3.188c-.966-.121-.944-.914-.944-1.453 0-.773.327-1.58.876-2.156a3.21 3.21 0 011.229-.799l.082 4.277a2.773 2.773 0 01-1.243.131zm2.427-.553l.046-4.109c.084-.004.166-.01.252-.01.773 0 1.494.145 1.885.361.391.217-1.023 2.713-2.183 3.758zm-8.95-7.668a.196.196 0 00-.196-.145h-1.95a.194.194 0 00-.194.144L.008 16.916c-.017.051-.011.076.062.076h1.733c.075 0 .099-.023.114-.072l1.008-3.318h3.496l1.008 3.318c.016.049.039.072.113.072h1.734c.072 0 .078-.025.062-.076-.014-.05-3.083-9.741-3.494-11.04zm-2.618 6.318l1.447-5.25 1.447 5.25H3.226z"></path></svg><span>Languages</span></span></a><ul class="menu__list"><li class="menu__list-item"><a href="/blog" target="_self" rel="noopener noreferrer" class="menu__link dropdown__link--active" style="text-transform:capitalize">English</a></li><li class="menu__list-item"><a href="/zh/blog" target="_self" rel="noopener noreferrer" class="menu__link" style="text-transform:capitalize">ç®€ä½“ä¸­æ–‡</a></li></ul></li><li class="menu__list-item"><a href="https://github.com/oam-dev/kubevela" target="_blank" rel="noopener noreferrer" class="menu__link header-github-link"></a></li></ul></div></div></div></nav><div class="main-wrapper blog-wrapper blog-list-page"><div class="container margin-vert--lg"><div class="row"><div class="col col--3"><div class="sidebar_2ahu thin-scrollbar"><h3 class="sidebarItemTitle_2hhb">Recent posts</h3><ul class="sidebarItemList_2xAf"><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/blog/2022/04/06/multi-cluster-management">Easily Manage your Application Shipment With Differentiated Configuration in Multi-Cluster</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/blog/2022/04/01/offline-deployment-practice copy">China Merchants Bank&#x27;s Practice on Offline Installation with KubeVela</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/blog/2022/03/02/kubevela-with-machine-learning">Machine Learning Practice with KubeVela</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/blog/2022/03/01/kubevela-generate-top-50-popular-resources-of-aws-using-100-lines-of-code">Generate top 50 popular resources of AWS using 100 lines of code</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/blog/2022/01/27/blog-1.2">KubeVela v1.2 - Focused on Developer Experience, Simplified Multi-Cluster Application Delivery</a></li></ul></div></div><main class="col col--7"><article class="margin-bottom--xl"><header><h2 class="margin-bottom--sm blogPostTitle_GeHD"><a href="/blog/2022/04/06/multi-cluster-management">Easily Manage your Application Shipment With Differentiated Configuration in Multi-Cluster</a></h2><div class="margin-vert--md"><time datetime="2022-04-06T00:00:00.000Z" class="blogPostDate_fNvV">April 6, 2022 Â· 7 min read</time></div><div class="avatar margin-vert--md"><a href="https://github.com/oam-dev/KubeVela" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img src="https://KubeVela.io/img/logo.svg" alt="Wei Duan"></a><div class="avatar__intro"><h4 class="avatar__name"><a href="https://github.com/oam-dev/KubeVela" target="_blank" rel="noopener noreferrer">Wei Duan</a></h4><small class="avatar__subtitle">KubeVela Team</small></div></div></header><div class="markdown"><p>Under today&#x27;s multi-cluster business scene, we often encounter these typical requirements: distribute to multiple specific clusters, specific group distributions according to business need, and differentiated configurations for multi-clusters.</p><p>KubeVela v1.3 iterates based on the previous multi-cluster function. This article will reveal how to use it to do swift multiple clustered deployment and management to address all your anxieties.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="before-starting"></a>Before Starting<a class="hash-link" href="#before-starting" title="Direct link to heading">#</a></h3><ol><li>Prepare a Kubernetes cluster as the control plane of KubeVela.</li><li>Make sure <a href="https://github.com/oam-dev/kubevela/releases/tag/v1.3.0" target="_blank" rel="noopener noreferrer">KubeVela v1.3</a> and KubeVela CLI v1.3.0 have been installed successfully.</li><li>The list of Kubeconfig from sub clusters that you want to manage. We will take three clusters naming beijing-1, beijing-2 and us-west-1 as examples.</li><li>Download and combine with <a href="https://github.com/oam-dev/sample/tree/master/12.multi_cluster_demo" target="_blank" rel="noopener noreferrer">Multi-Cluster-Demo</a> to better understand how to use the KubeVela multi-cluster capabilities.</li></ol><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="distribute-to-multiple-specified-clusters"></a>Distribute to Multiple Specified Clusters<a class="hash-link" href="#distribute-to-multiple-specified-clusters" title="Direct link to heading">#</a></h3><p>Distributing multiple specified clusters is the most basic multi-cluster management operation. In KubeVela, you will use a policy called <code>topology</code> to implement it. The cluster will be listed in the attribute <code>clusters</code>, an array.</p><p>First let&#x27;s make sure switching kubeconfig to the control plane cluster, go with <code>vela cluster join</code> to include in the 3 clusters of Beijing-1, Beijing-2 and us-west-1:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><div tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token plain">âžœ   vela cluster join beijing-1.kubeconfig --name beijing-1</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">âžœ   vela cluster join beijing-2.kubeconfig --name beijing-2</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">âžœ   vela cluster join us-west-1.kubeconfig --name us-west-1</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">âžœ   vela cluster list</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">CLUSTER         TYPE            ENDPOINT                    ACCEPTED    LABELS</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">beijing-1       X509Certificate https://47.95.22.71:6443    true</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">beijing-2       X509Certificate https://47.93.117.83:6443   true</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">us-west-1       X509Certificate https://47.88.31.118:6443   true</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>Then open multi-cluster-demo, look into <code>Basic.yaml</code>:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><div tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token plain">apiVersion: core.oam.dev/v1beta1</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">kind: Application</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">metadata:</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  name: example-app</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  namespace: default</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">spec:</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  components:</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    - name: hello-world-server</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      type: webservice</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      properties:</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        image: crccheck/hello-world</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        port: 8000</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      traits:</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        - type: scaler</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">          properties:</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            replicas: 3</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        - type: gateway</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">          properties:</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            domain: testsvc-mc.example.com</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            # classInSpec : true   If the sub clusters has Kubernetes versions below v1.20 installed, please add this field</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            http:</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">              &quot;/&quot;: 8000</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  policies:</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    - type: topology</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      name: beijing-clusters</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      properties:</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        clusters: [&quot;beijing-1&quot;,&quot;beijing-2&quot;]</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>It can be seen that this app uses the component of type <code>webservice</code> and distributes 3 Deployments to beijing-1 and beijing-2 clusters through the <code>topology</code> policy.</p><p>Please note that the premise of successfully distributing resource into managed clusters is that it must contain the exactly same namespace as control plane did.  Since each cluster has the <strong><code>default</code></strong> namespace by default, we won&#x27;t be worry in this case. But suppose we change the namespace in <strong><code>basic.yaml</code></strong> to be <strong><code>multi-cluster</code></strong>, we will receive an error:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><div tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token plain">... </span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain"> Status:        runningWorkflow</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">Workflow:</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  mode: DAG</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  finished: false</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  Suspend: false</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  Terminated: false</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  Steps</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  - id:9fierfkhsc</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    name:deploy-beijing-clusters</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    type:deploy</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    phase:failed</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    message:step deploy: step deploy: run step(provider=oam,do=components-apply): Found 1 errors. [(failed to apply component beijing-1-multi-cluster-0: HandleComponentsRevision: failed to create componentrevision beijing-1/multi-cluster/hello-world-server-v1: namespaces &quot;multi-cluster&quot; not found)]</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">Services:</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">...</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p><strong>In future versions of KubeVela, we plan to support a comprehensive Authentication System, more convenient and more securely to: create namespaces in managed cluster through the hub cluster in quick moves.</strong></p><p>After creating the sub cluster&#x27;s namespace, come back to the control plane cluster to create the application and ship out resources:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><div tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token plain">âžœ   vela up -f basic.yaml</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">Applying an application in vela K8s object format...</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">&quot;patching object&quot; name=&quot;example-app&quot; resource=&quot;core.oam.dev/v1beta1, Kind=Application&quot;</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">âœ… App has been deployed ðŸš€ðŸš€ðŸš€</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    Port forward: vela port-forward example-app</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">             SSH: vela exec example-app</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">         Logging: vela logs example-app</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      App status: vela status example-app</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  Service status: vela status example-app --svc hello-world-server</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>We use <code>vela status &lt;App Name&gt;</code> to view detailed infos about this app:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><div tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token plain">âžœ   vela status example-app</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">About:</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  Name:         example-app</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  Namespace:    default</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  Created at:   2022-03-25 17:42:33 +0800 CST</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  Status:       running</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">Workflow:</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  mode: DAG</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  finished: true</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  Suspend: false</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  Terminated: false</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  Steps</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  - id:wftf9d4exj</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    name:deploy-beijing-clusters</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    type:deploy</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    phase:succeeded</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    message:</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">Services:</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  - Name: hello-world-server</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    Cluster: beijing-1  Namespace: default</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    Type: webservice</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    Healthy Ready:3/3</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    Traits:</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      âœ… scaler      âœ… gateway: Visiting URL: testsvc-mc.example.com, IP: 60.205.222.30</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  - Name: hello-world-server</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    Cluster: beijing-2  Namespace: default</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    Type: webservice</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    Healthy Ready:3/3</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    Traits:</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      âœ… scaler      âœ… gateway: Visiting URL: testsvc-mc.example.com, IP: 182.92.222.128</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>Both the beijing-1 and beijing-2 have issued the corresponding resources, they also displayed external access IP addresses, and you can therefore make it public for your users.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="use-cluster-labels-to-do-grouping"></a>Use Cluster Labels to Do Grouping<a class="hash-link" href="#use-cluster-labels-to-do-grouping" title="Direct link to heading">#</a></h3><p>In addition to the above basic need, we often encounter additional situations: cross-regional deployment to certain clusters, specify which cloud provider&#x27;s cluster, etc. In order to achieve a similar goal, the <code>labels</code> feature can be used.</p><p>Here, suppose the us-west-1 cluster comes from AWS, we must additionally apply to the AWS cluster. You can use the <code>vela cluster labels add</code> command to tag the cluster. Of course, if there is more of AWS related clusters such as us-west-2, it will be handled as well after they were labeled:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><div tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token plain">âžœ  ~ vela cluster labels add us-west-1 provider=AWS</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">Successfully update labels for cluster us-west-1 (type: X509Certificate).</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">provider=AWS</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">âžœ  ~ vela cluster list</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">CLUSTER         TYPE            ENDPOINT                    ACCEPTED    LABELS</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">beijing-1       X509Certificate https://47.95.22.71:6443    true</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">beijing-2       X509Certificate https://47.93.117.83:6443   true</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">us-west-1       X509Certificate https://47.88.31.118:6443   true        provider=AWS</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>Next we update the <code>basic.yaml</code> to add an application policy <code>topology-aws</code>:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><div tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token plain">...</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  policies:</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    - type: topology</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      name: beijing-clusters</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      properties:</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        clusters: [&quot;beijing-1&quot;,&quot;beijing-2&quot;]</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    - type: topology</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      name: topology-aws</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      properties:</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        clusterLabelSelector:</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">          provider: AWS</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>In order save your time, please deploy <code>intermediate.yaml</code> directly:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><div tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token plain">âžœ  ~ vela up -f intermediate.yaml</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>Review the status of the application again:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><div tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token plain">âžœ   vela status example-app</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">...</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  - Name: hello-world-server</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    Cluster: us-west-1  Namespace: default</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    Type: webservice</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    Healthy Ready:3/3</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    Traits:</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      âœ… scaler      âœ… gateway: Visiting URL: testsvc-mc.example.com, IP: 192.168.40.10</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="differentiated-configuration"></a>Differentiated Configuration<a class="hash-link" href="#differentiated-configuration" title="Direct link to heading">#</a></h3><p>Apart from above scenarios, we tend to have more application strategic needs, such as high availability of hoping to distribute 5 replicas. In this case, use the <code>override</code> policy:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><div tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token plain">...        </span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        clusterLabelSelector:</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">          provider: AWS</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    -  type: override</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">       name: override-high-availability</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">       properties:</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">          components:</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            - type: webservice</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">              traits:</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">              - type: scaler</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                properties:</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                  replicas: 5</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>At the same time, we hope that only AWS clusters can get high availability. Then we can expect KubeVela&#x27;s workflow give us a hand. We use the following workflow: it aims to deploy this app by, first distributing to Beijing&#x27;s clusters through the <code>deploy-beijing</code> policy, then distributing 5 copies to clusters which were labeled as AWS:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><div tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token plain">...                </span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                properties:</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                  replicas: 5</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  workflow:</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    steps:</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      - type: deploy</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        name: deploy-beijing</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        properties:</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">          policies: [&quot;beijing-clusters&quot;]</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      - type: deploy</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        name: deploy-aws</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        properties:</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">          policies: [&quot;override-high-availability&quot;,&quot;topology-aws&quot;]</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>Then we attach the above policy and workflow to <code>intermediate.yaml</code> and make it to <code>advanced.yaml</code>:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><div tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token plain">...</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  policies:</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    - type: topology</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      name: beijing-clusters</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      properties:</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        clusters: [&quot;beijing-1&quot;,&quot;beijing-2&quot;]</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    - type: topology</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      name: topology-aws</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      properties:</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        clusterLabelSelector:</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">          provider: AWS</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    -  type: override</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">       name: override-high-availability</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">       properties:</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">          components:</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            - type: webservice</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">              traits:</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">              - type: scaler</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                properties:</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                  replicas: 5</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  workflow:</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    steps:</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      - type: deploy</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        name: deploy-beijing</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        properties:</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">          policies: [&quot;beijing-clusters&quot;]</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      - type: deploy</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        name: deploy-aws</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        properties:</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">          policies: [&quot;override-high-availability&quot;,&quot;topology-aws&quot;]</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>Then deploy it, view the status of the application:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><div tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token plain">âžœ   vela up -f advanced.yaml</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">Applying an application in vela K8s object format...</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">&quot;patching object&quot; name=&quot;example-app&quot; resource=&quot;core.oam.dev/v1beta1, Kind=Application&quot;</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">âœ… App has been deployed ðŸš€ðŸš€ðŸš€</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    Port forward: vela port-forward example-app</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">             SSH: vela exec example-app</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">         Logging: vela logs example-app</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      App status: vela status example-app</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  Service status: vela status example-app --svc hello-world-serverapplication.core.oam.dev/podinfo-app configured</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  </span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">âžœ   vela status example-app</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">...</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  - Name: hello-world-server</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    Cluster: us-west-1  Namespace: default</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    Type: webservice</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    Healthy Ready:5/5</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    Traits:</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      âœ… scaler      âœ… gateway: Visiting URL: testsvc-mc.example.com, IP: 192.168.40.10</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>The above all are what we&#x27;d like to share with you for this time, thank you for reading and trying them out.</p><p><a href="https://kubevela.io/docs/install" target="_blank" rel="noopener noreferrer">We invite you to explore KubeVela v1.3 for more</a> to meet further complex requirements on business, such as <a href="https://kubevela.io/docs/next/case-studies/multi-cluster#override-default-configurations-in-clusters" target="_blank" rel="noopener noreferrer">dig deep</a> in differentiated configurations to use <code>override</code> application policy to either override all resources on one type or only certain specific components.</p></div><footer class="row margin-vert--lg"><div class="col"><strong>Tags:</strong><a class="margin-horiz--sm" href="/blog/tags/kube-vela">KubeVela</a></div></footer></article><article class="margin-bottom--xl"><header><h2 class="margin-bottom--sm blogPostTitle_GeHD"><a href="/blog/2022/04/01/offline-deployment-practice copy">China Merchants Bank&#x27;s Practice on Offline Installation with KubeVela</a></h2><div class="margin-vert--md"><time datetime="2022-04-01T00:00:00.000Z" class="blogPostDate_fNvV">April 1, 2022 Â· 6 min read</time></div><div class="avatar margin-vert--md"><a href="http://www.cmbchina.com/" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img src="/img/china-merchants-bank.jpg" alt="Xiangbo Ma"></a><div class="avatar__intro"><h4 class="avatar__name"><a href="http://www.cmbchina.com/" target="_blank" rel="noopener noreferrer">Xiangbo Ma</a></h4><small class="avatar__subtitle">(Cloud platform development team)</small></div></div></header><div class="markdown"><p>The cloud platform development team of China Merchants Bank has been trying out KubeVela since 2021 internally and aims to using it for enhancing our primary application delivery and management capabilities. Due to the specific security concern for financial insurance industry, network control measurements are relatively strict, and our intranet cannot directly pull Docker Hub image, and there is no Helm image source available as well. Therefore, in order to landing KubeVela in the intranet, you must perform a complete offline installation.</p><p>This article will take the KubeVela V1.2.5 version as an example, introduce the offline installation practice to help other users easier to complete KubeVela&#x27;s deployment in offline environment.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="kubevela-offline-installation-solution"></a>KubeVela Offline Installation Solution<a class="hash-link" href="#kubevela-offline-installation-solution" title="Direct link to heading">#</a></h2><p>We divide the offline installation of KubeVela in three parts, which are Vela CLI, Vela Core, and Addon offline installation. Each part mainly involves the loading of the relevant Docker image and Helm&#x27;s package, which can greatly speed up deployment process in offline environment.</p><p>Before doing so, please ensure that Kubernetes cluster version is  <code>&gt;= v1.19 &amp;&amp; &lt; v1.22</code>. One way of KubeVela as a control plane relies on Kubernetes, which can be placed in any product or in any cloud provider. At the same time, you can also use Kind or Minikube to deploy KubeVela locally.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="vela-cli-offline-installation"></a>Vela CLI Offline Installation<a class="hash-link" href="#vela-cli-offline-installation" title="Direct link to heading">#</a></h3><ul><li>First, you need to download of the binary version of <code>vela</code> that you want by checking KubeVela <a href="https://github.com/oam-dev/kubevela/releases" target="_blank" rel="noopener noreferrer">Release Log</a></li><li>Unzip binary files and configure the appropriate environment variables in <code>$PATH</code><ul><li>Unzip binary file<ul><li><code>tar -zxvf vela-v1.2.5-linux-amd64.tar.gz</code></li><li><code>mv ./linux-amd64/vela /usr/local/bin/vela</code></li></ul></li><li>Set environment variables<ul><li><code>vi /etc/profile</code></li><li><code>export PATH=&quot;$PATH:/usr/local/bin&quot;</code></li><li><code>source /etc/profile</code></li></ul></li><li>Verify the installation of Vela CLI through <code>vela version</code></li></ul></li></ul><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly shell"><div tabindex="0" class="prism-code language-shell codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token plain">CLI VERSION: V1.2.5</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">Core Version:</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">GitRevision: git-ef80b66</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">GOLANGVERSION: Go1.17.7</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><ul><li>At this point, Vela CLI has been deployed offline!</li></ul><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="vela-core-offline-installation"></a>Vela Core Offline Installation<a class="hash-link" href="#vela-core-offline-installation" title="Direct link to heading">#</a></h3><ul><li>Before deploying Vela Core offline, first you need to install <a href="https://helm.sh/docs/intro/install/" target="_blank" rel="noopener noreferrer">Helm</a> in an offline environment and its version needs to meet <code>v3.2.0+</code></li><li>Prepare Docker image. Vela Core&#x27;s deployment mainly involves 5 images, you need to first visit the Docker Hub in extranet to download the corresponding images, then load them to offline environment<ul><li>Pull the image from Docker Hub<ul><li><code>docker pull oamdev/vela-core:v1.2.5</code></li><li><code>docker pull oamdev/cluster-gateway:v1.1.7</code></li><li><code>docker pull oamdev/kube-webhook-certgen:v2.3</code></li><li><code>docker pull oamdev/alpine-k8s:1.18.2</code></li><li><code>docker pull oamdev/hello-world:v1</code></li></ul></li><li>Save image to local disks<ul><li><code>docker save -o vela-core.tar oamdev/vela-core:v1.2.5</code></li><li><code>docker save -o cluster-gateway.tar oamdev/cluster-gateway:v1.1.7</code></li><li><code>docker save -o kube-webhook-certgen.tar oamdev/kube-webhook-certgen:v2.3</code></li><li><code>docker save -o alpine-k8s.tar oamdev/alpine-k8s:1.18.2</code></li><li><code>docker save -o hello-world.tar oamdev/hello-world:v1</code></li></ul></li><li>Re-load the image in the offline environment<ul><li><code>docker load vela-core.tar</code></li><li><code>docker load cluster-gateway.tar</code></li><li><code>docker load kube-webhook-certgen.tar</code></li><li><code>docker load alpine-k8s.tar</code></li><li><code>docker load hello-world.tar</code></li></ul></li></ul></li><li>Download <a href="https://github.com/oam-dev/KubeVela/releases" target="_blank" rel="noopener noreferrer">KubeVela Core</a>, copy it to offline environment and use Helm to repackage<ul><li>Repackage the KubeVela source code and install the chart package to the control cluster offline<ul><li><code>helm package kubevela/charts/vela-core --destination kubevela/charts</code></li><li><code>helm install --create-namespace -n vela-system kubevela kubevela/charts/vela-core-0.1.0.tgz --wait</code></li></ul></li><li>Check the output</li></ul></li></ul><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly shell"><div tabindex="0" class="prism-code language-shell codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token plain">KubeVela Control Plane Has Been successfully </span><span class="token builtin class-name" style="color:rgb(189, 147, 249)">set</span><span class="token plain"> up on your cluster.</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><ul><li>At this point, Vela Core has been deployed offline!</li></ul><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="addon-offline-installation"></a>Addon Offline Installation<a class="hash-link" href="#addon-offline-installation" title="Direct link to heading">#</a></h3><ul><li>First download <a href="https://github.com/oam-dev/catalog" target="_blank" rel="noopener noreferrer">Catalog Source</a> and copy it to offline environment</li><li>Here, we will take VelaUX, one of many more addons, as an example. First prepare its Docker image, VelaUX mainly involve 2 images, you need to first access the extranet to download the corresponding image from Docker Hub, then load it to offline environment<ul><li>Pull the image from Docker Hub<ul><li><code>docker pull oamdev/vela-apiserver:v1.2.5</code></li><li><code>docker pull oamdev/velaux:v1.2.5</code></li></ul></li><li>Save image to local disks<ul><li><code>docker save -o vela-apiserver.tar oamdev/vela-apiserver:v1.2.5</code></li><li><code>docker save -o velaux.tar oamdev/velaux:v1.2.5</code></li></ul></li><li>Re-load the image in the offline environment<ul><li><code>docker load vela-apiserver.tar</code></li><li><code>docker load velaux.tar</code></li></ul></li></ul></li><li>Install VelaUX<ul><li>Install VelaUX via Vela CLI<ul><li><code>vela addon enable catalog-master/addons/velaux</code></li></ul></li><li>Check the output</li></ul></li></ul><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly shell"><div tabindex="0" class="prism-code language-shell codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token plain">  Addon: velaux enabled Successfully.</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><ul><li>If there is a cluster installed route Controller or Nginx Ingress Controller and also linked with an available domain, you can deploy external routing to make VelaUX accessible. Here present Openshift Route as an example, you can also choose Ingress if you wish</li></ul><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly yaml"><div tabindex="0" class="prism-code language-yaml codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token key atrule">apiVersion</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> route.openshift.io/v1</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token key atrule">kind</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> Route</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token key atrule">metadata</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> velaux</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">route</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token key atrule">namespace</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> vela</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">system</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token key atrule">spec</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token key atrule">host</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> velaux.xxx.xxx.cn</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token key atrule">port</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">targetPort</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token number">80</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token key atrule">to</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">kind</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> Service</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> velaux</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">weight</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token number">100</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token key atrule">wildcardPolicy</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> None</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><ul><li>Check the installation</li></ul><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly shell"><div tabindex="0" class="prism-code language-shell codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token function" style="color:rgb(80, 250, 123)">curl</span><span class="token plain"> -I -m </span><span class="token number">10</span><span class="token plain"> -o /dev/null -s -w %</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain">http_code</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"> http://velaux.xxx.xxx.cn/applications</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><ul><li>At this point, VelaUX has been deployed offline! At the same time, for other types of Addon&#x27;s offline deployment, access to the corresponding directory of the <a href="https://github.com/oam-dev/catalog" target="_blank" rel="noopener noreferrer">Catalog Source</a> and repeat the above moves, you would complete all the addons&#x27; offline deployments for good.</li></ul><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="summarize"></a>Summarize<a class="hash-link" href="#summarize" title="Direct link to heading">#</a></h2><p>During offline deployment, we also try to save Vela Core and Addon&#x27;s resource that generated to be YAML files after deploying in extranet and re-deploy them in an offline environment, but because of all different kinds of resource involved in and it requires many other authorization issues to resolve, this way is more than cumbersome.</p><p>With this practice of KubeVela&#x27;s offline deployment, we hope it help you build a complete set of KubeVela in offline environment much faster. Offline installation is pretty much a pain point for most developers, we also see that the KubeVela community is introducing the brand new <a href="https://github.com/oam-dev/velad" target="_blank" rel="noopener noreferrer">velad</a>, a fully offline, highly accountable installation tool. Velad can help automate completion by making many steps as one, such as preparing clusters, downloading and packing image, installing and etc. Further more, it do support many features: In Linux machine (such as Alibaba Cloud ECS) we can locally spin up a cluster to install Vela-Core; while starting a KubeVela control plane, do not have to worry about its data to be lost when machine behind it accidentally was shutdown; Velad can stores all the data from control plane cluster into a traditional database (such as MySQL deployed on another ECS).</p><p>In the recent version to come, China Merchants Bank will increase the efforts in the open source community of KubeVela, actively building: enterprise-level capacity, enhancement on multi-cluster, offline deployment and application-level observability. We&#x27;ll also be contributing the financial industry&#x27;s user scenarios and business needs, driving cloud-native ecology achieve more easily and efficient application management experience, and at last but not at least, welcome you the community member to join us together in this journey.</p></div><footer class="row margin-vert--lg"><div class="col"><strong>Tags:</strong><a class="margin-horiz--sm" href="/blog/tags/kube-vela">KubeVela</a></div></footer></article><article class="margin-bottom--xl"><header><h2 class="margin-bottom--sm blogPostTitle_GeHD"><a href="/blog/2022/03/02/kubevela-with-machine-learning">Machine Learning Practice with KubeVela</a></h2><div class="margin-vert--md"><time datetime="2022-03-02T00:00:00.000Z" class="blogPostDate_fNvV">March 2, 2022 Â· 10 min read</time></div><div class="avatar margin-vert--md"><a href="https://github.com/oam-dev/kubevela" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img src="https://kubevela.io/img/logo.svg" alt="Tianxin Dong"></a><div class="avatar__intro"><h4 class="avatar__name"><a href="https://github.com/oam-dev/kubevela" target="_blank" rel="noopener noreferrer">Tianxin Dong</a></h4><small class="avatar__subtitle">KubeVela team</small></div></div></header><div class="markdown"><p>At the background of Machine learning goes viral, AI engineers not only need to train and debug their models, but also need to deploy them online to verify how it looks(of course sometimes, this part of the work is done by AI platform engineers. ). It is very tedious and draining AI engineers.</p><p>In the cloud-native era, our model training and model serving are also usually performed on the cloud. Doing so not only improves scalability, but also improves resource utility. This is very effective for machine learning scenarios that consume a lot of computing resources.</p><p>But it is often difficult for AI engineers to use cloud-native techniques. The concept of cloud native has become more complex over time. Even to deploy a simple model serving on cloud native architecture, AI engineers may need to learn several additional concepts: Deployment, Service, Ingress, etc.</p><p>As a simple, easy-to-use, and highly scalable cloud-native application management tool, KubeVela enables developers to quickly and easily define and deliver applications on Kubernetes without knowing any details about the underlying cloud-native infrastructure. KubeVela&#x27;s rich extensibility extends to AI addons and provide functions such as model training, model serving, and A/B testing, covering the basic needs of AI engineers and helping AI engineers quickly conduct model training and model serving in a cloud-native environment.</p><p>This article mainly focus on how to use KubeVela&#x27;s AI addon to help engineers complete model training and model serving more easily.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="kubevela-ai-addon"></a>KubeVela AI Addon<a class="hash-link" href="#kubevela-ai-addon" title="Direct link to heading">#</a></h2><p>The KubeVela AI addon is divided into two: model training and model serving. The model training addon is based on KubeFlow&#x27;s training-operator and can support distributed model training in different frameworks such as TensorFlow, PyTorch, and MXNet. The model serving addon is based on Seldon Core, which can easily use the model to start the model serving, and also supports advanced functions such as traffic distribution and A/B testing.</p><p><img alt="alt" src="/assets/images/ai-addon-en-5857a7d1438f1c37dd3b5d3d477a5f8e.png"></p><p>Through the KubeVela AI addon, the deployment of model training and serving tasks can be significantly simplified. At the same time, the process of model training and serving can be combined with KubeVela&#x27;s own workflow, multi-cluster and other functions to complete production-level services.</p><blockquote><p>Note: You can find all source code and YAML files in <a href="https://github.com/oam-dev/samples/tree/master/11.Machine_Learning_Demo" target="_blank" rel="noopener noreferrer">KubeVela Samples</a>. If you want to use the model pretrained in this example, <code>style-model.yaml</code> and <code>color-model.yaml</code> in the folder will do that and copy the model into the PVC.</p></blockquote><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="model-training"></a>Model Training<a class="hash-link" href="#model-training" title="Direct link to heading">#</a></h2><p>First enable the two addons for model training and model serving.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly bash"><div tabindex="0" class="prism-code language-bash codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token plain">vela addon </span><span class="token builtin class-name" style="color:rgb(189, 147, 249)">enable</span><span class="token plain"> model-training</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">vela addon </span><span class="token builtin class-name" style="color:rgb(189, 147, 249)">enable</span><span class="token plain"> model-serving</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>Model training includes two component types, <code>model-training</code> and <code>jupyter-notebook</code>, and model serving includes the <code>model-serving</code> component type. The specific parameters of these three components can be viewed through the <code>vela show</code> command.</p><blockquote><p>You can also read <a href="https://kubevela.io/en/docs/next/reference/addons/ai" target="_blank" rel="noopener noreferrer">KubeVela AI Addon Documentation</a> for more information.</p></blockquote><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly bash"><div tabindex="0" class="prism-code language-bash codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token plain">vela show model-training</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">vela show jupyter-notebook</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">vela show model-serving</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>Let&#x27;s train a simple model using the TensorFlow framework that turns gray images into colored ones. Deploy the following YAML file:</p><blockquote><p>Note: The source code for model training comes from: <a href="https://github.com/emilwallner/Coloring-greyscale-images" target="_blank" rel="noopener noreferrer">emilwallner/Coloring-greyscale-images</a></p></blockquote><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly yaml"><div tabindex="0" class="prism-code language-yaml codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token key atrule">apiVersion</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> core.oam.dev/v1beta1</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token key atrule">kind</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> Application</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token key atrule">metadata</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> training</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">serving</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">namespace</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> default</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token key atrule">spec</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">components</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)"># Train the model</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> demo</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">training</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">type</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> model</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">training</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">properties</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token comment" style="color:rgb(98, 114, 164)"># Mirror of the trained model</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">image</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> fogdong/train</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">color</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain">v1</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token comment" style="color:rgb(98, 114, 164)"># A framework for model training</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">framework</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> tensorflow</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token comment" style="color:rgb(98, 114, 164)"># Declare storage to persist models. Here, the default storage class in the cluster will be used to create the PVC</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">storage</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;my-pvc&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token key atrule">mountPath</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;/model&quot;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>At this point, KubeVela will pull up a <code>TFJob</code> for model training.</p><p>It&#x27;s hard to see what&#x27;s going on just by training the model. Let&#x27;s modify this YAML file and put the model serving after the model training step. At the same time, because the model serving will directly start the model, and the input and output of the model are not intuitive (ndarray or Tensor), therefore, we deploy a test service to call the service and convert the result into an image.</p><p>Deploy the following YAML file:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly yaml"><div tabindex="0" class="prism-code language-yaml codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token key atrule">apiVersion</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> core.oam.dev/v1beta1</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token key atrule">kind</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> Application</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token key atrule">metadata</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> training</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">serving</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">namespace</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> default</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token key atrule">spec</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">components</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)"># Train the model</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> demo</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">training</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">type</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> model</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">training</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">properties</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">image</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> fogdong/train</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">color</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain">v1</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">framework</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> tensorflow</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">storage</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;my-pvc&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token key atrule">mountPath</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;/model&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  </span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)"># Start the model serving</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> demo</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">serving</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">type</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> model</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">serving</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)"># The model serving will start after model training is complete</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">dependsOn</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> demo</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">training</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">properties</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token comment" style="color:rgb(98, 114, 164)"># The protocol used to start the model serving can be left blank. By default, seldon&#x27;s own protocol is used.</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">protocol</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> tensorflow</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">predictors</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> model</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token comment" style="color:rgb(98, 114, 164)"># The number of replicas for the model serving</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token key atrule">replicas</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token number">1</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token key atrule">graph</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token comment" style="color:rgb(98, 114, 164)"># model name</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> my</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">model</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token comment" style="color:rgb(98, 114, 164)"># model frame</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token key atrule">implementation</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> tensorflow</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token comment" style="color:rgb(98, 114, 164)"># Model address, the previous step will save the trained model to the pvc of my-pvc, so specify the address of the model through pvc://my-pvc</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token key atrule">modelUri</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> pvc</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain">//my</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">pvc</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)"># test model serving</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> demo</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">rest</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">serving</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">type</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> webservice</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)"># The test service will start after model training is complete</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">dependsOn</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> demo</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">serving</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">properties</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">image</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> fogdong/color</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">serving</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain">v1</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token comment" style="color:rgb(98, 114, 164)"># Use LoadBalancer to expose external addresses for easy to access</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">exposeType</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> LoadBalancer</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">env</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> URL</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token comment" style="color:rgb(98, 114, 164)"># The address of the model serving</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token key atrule">value</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> http</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain">//ambassador.vela</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">system.svc.cluster.local/seldon/default/demo</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">serving/v1/models/my</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">model</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain">predict</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">ports</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token comment" style="color:rgb(98, 114, 164)"># Test service port</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">port</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token number">3333</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token key atrule">expose</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token boolean important">true</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>After deployment, check the status of the application with <code>vela ls</code>:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly bash"><div tabindex="0" class="prism-code language-bash codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token plain">$ vela </span><span class="token function" style="color:rgb(80, 250, 123)">ls</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">training-serving        demo-training       model-training          running healthy Job Succeeded   </span><span class="token number">2022</span><span class="token plain">-03-02 </span><span class="token number">17</span><span class="token plain">:26:40 +0800 CST</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">â”œâ”€                      demo-serving        model-serving           running healthy Available       </span><span class="token number">2022</span><span class="token plain">-03-02 </span><span class="token number">17</span><span class="token plain">:26:40 +0800 CST</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">â””â”€                      demo-rest-serving   webservice              running healthy Ready:1/1       </span><span class="token number">2022</span><span class="token plain">-03-02 </span><span class="token number">17</span><span class="token plain">:26:40 +0800 CST</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>As you can see, the application has started normally. Use <code>vela status &lt;app-name&gt; --endpoint</code> to view the service address of the application.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly bash"><div tabindex="0" class="prism-code language-bash codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token plain">$ vela status training-serving --endpoint</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">+---------+-----------------------------------+---------------------------------------------------+</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token operator">|</span><span class="token plain"> CLUSTER </span><span class="token operator">|</span><span class="token plain">     REF</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">KIND/NAMESPACE/NAME</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain">      </span><span class="token operator">|</span><span class="token plain">                     ENDPOINT                      </span><span class="token operator">|</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">+---------+-----------------------------------+---------------------------------------------------+</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token operator">|</span><span class="token plain">         </span><span class="token operator">|</span><span class="token plain"> Service/default/demo-rest-serving </span><span class="token operator">|</span><span class="token plain"> tcp://47.251.10.177:3333                          </span><span class="token operator">|</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token operator">|</span><span class="token plain">         </span><span class="token operator">|</span><span class="token plain"> Service/vela-system/ambassador    </span><span class="token operator">|</span><span class="token plain"> http://47.251.36.228/seldon/default/demo-serving  </span><span class="token operator">|</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token operator">|</span><span class="token plain">         </span><span class="token operator">|</span><span class="token plain"> Service/vela-system/ambassador    </span><span class="token operator">|</span><span class="token plain"> https://47.251.36.228/seldon/default/demo-serving </span><span class="token operator">|</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">+---------+-----------------------------------+---------------------------------------------------+</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>The application has three service addresses, the first is the address of our test service, the second and third are the addresses of the native model.</p><p>We can call the test service to see the effect of the model: the test service will read the content of the image, convert it into a <code>Tensor</code> and request the model serving, and finally convert the <code>Tensor</code> returned by the model serving into an image to return.</p><p>We choose a black and white female image as input:</p><p><img alt="alt" src="/assets/images/woman-grey-7d5fe53e7da342e9136cf2473d2c4f8b.png"></p><p>After the request, you can see that a color image is output:</p><p><img alt="alt" src="/assets/images/test-request-d575b2a24081dc7da768f9dd8fd18572.png"></p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="model-servings-canary-testing"></a>Model Servings: Canary Testing<a class="hash-link" href="#model-servings-canary-testing" title="Direct link to heading">#</a></h2><p>In addition to starting the model serving directly, we can also use multiple versions of the model in one model serving and assign different traffic to them for canary testing.</p><p>Deploy the following YAML, you can see that both the v1 version of the model and the v2 version of the model are set to 50% traffic. Again, we deploy a test service behind the model serving:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly yaml"><div tabindex="0" class="prism-code language-yaml codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token key atrule">apiVersion</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> core.oam.dev/v1beta1</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token key atrule">kind</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> Application</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token key atrule">metadata</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> color</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">serving</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">namespace</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> default</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token key atrule">spec</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">components</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> color</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">model</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">serving</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">type</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> model</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">serving</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">properties</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">protocol</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> tensorflow</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">predictors</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> model1</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token key atrule">replicas</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token number">1</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token comment" style="color:rgb(98, 114, 164)"># v1 version model traffic is 50</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token key atrule">traffic</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token number">50</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token key atrule">graph</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> my</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">model</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token key atrule">implementation</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> tensorflow</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token comment" style="color:rgb(98, 114, 164)"># Model address, our v1 version model is stored under the /model/v1 path in the pvc of color-model, so specify the address of the model through pvc://color-model/model/v1</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token key atrule">modelUri</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> pvc</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain">//color</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">model/model/v1</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> model2</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token key atrule">replicas</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token number">1</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token comment" style="color:rgb(98, 114, 164)"># v2 version model traffic is 50</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token key atrule">traffic</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token number">50</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token key atrule">graph</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> my</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">model</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token key atrule">implementation</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> tensorflow</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token comment" style="color:rgb(98, 114, 164)"># Model address, our v2 version model is stored under the /model/v2 path in the pvc of color-model, so specify the address of the model through pvc://color-model/model/v2</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token key atrule">modelUri</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> pvc</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain">//color</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">model/model/v2</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> color</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">rest</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">serving</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">type</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> webservice</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">dependsOn</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> color</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">model</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">serving</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">properties</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">image</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> fogdong/color</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">serving</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain">v1</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">exposeType</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> LoadBalancer</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">env</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> URL</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token key atrule">value</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> http</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain">//ambassador.vela</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">system.svc.cluster.local/seldon/default/color</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">model</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">serving/v1/models/my</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">model</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain">predict</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">ports</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">port</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token number">3333</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token key atrule">expose</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token boolean important">true</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>When the model deployment is complete, use <code>vela status &lt;app-name&gt; --endpoint</code> to view the address of the model serving:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly bash"><div tabindex="0" class="prism-code language-bash codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token plain">$ vela status color-serving --endpoint</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">+---------+------------------------------------+----------------------------------------------------------+</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token operator">|</span><span class="token plain"> CLUSTER </span><span class="token operator">|</span><span class="token plain">      REF</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">KIND/NAMESPACE/NAME</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain">      </span><span class="token operator">|</span><span class="token plain">                         ENDPOINT                         </span><span class="token operator">|</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">+---------+------------------------------------+----------------------------------------------------------+</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token operator">|</span><span class="token plain">         </span><span class="token operator">|</span><span class="token plain"> Service/vela-system/ambassador     </span><span class="token operator">|</span><span class="token plain"> http://47.251.36.228/seldon/default/color-model-serving  </span><span class="token operator">|</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token operator">|</span><span class="token plain">         </span><span class="token operator">|</span><span class="token plain"> Service/vela-system/ambassador     </span><span class="token operator">|</span><span class="token plain"> https://47.251.36.228/seldon/default/color-model-serving </span><span class="token operator">|</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token operator">|</span><span class="token plain">         </span><span class="token operator">|</span><span class="token plain"> Service/default/color-rest-serving </span><span class="token operator">|</span><span class="token plain"> tcp://47.89.194.94:3333                                  </span><span class="token operator">|</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">+---------+------------------------------------+----------------------------------------------------------+</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>Request the model with a black and white city image:</p><p><img alt="alt" src="/assets/images/chicago-grey-9beb20b9876bfbb19f12ccb570ad3e77.png"></p><p>As you can see, the result of the first request is as follows. While the sky and ground are rendered in color, the city itself is black and white:</p><p><img alt="alt" src="/assets/images/canary-request1-de4f9f1c4f81b200f2827e5277e8bc60.png"></p><p>Request again, you can see that in the result of this request, the sky, ground and city are rendered in color:</p><p><img alt="alt" src="/assets/images/canary-request2-1ce63a83354786cb7e9f56891002771a.png"></p><p>By distributing traffic to different versions of the model, it can help us better judge the model results.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="model-serving-ab-testing"></a>Model Serving: A/B Testing<a class="hash-link" href="#model-serving-ab-testing" title="Direct link to heading">#</a></h2><p>For a black and white image, we can turn it into color through the model. Or in another way, we can transfer the style of the original image by uploading another style image.</p><p>Do our users love colorful pictures more or pictures of different styles more? We can explore this question by conducting A/B testing.</p><p>Deploy the following YAML, by setting <code>customRouting</code>, forward the request with <code>style: transfer</code> in the <code>Header</code> to the model of style transfer. At the same time, make this style transfer model share the same address as the colorized model.</p><blockquote><p>Note: The model for style transfer comes from <a href="https://tfhub.dev/google/magenta/arbitrary-image-stylization-v1-256/2" target="_blank" rel="noopener noreferrer">TensorFlow Hub</a></p></blockquote><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly yaml"><div tabindex="0" class="prism-code language-yaml codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token key atrule">apiVersion</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> core.oam.dev/v1beta1</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token key atrule">kind</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> Application</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token key atrule">metadata</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> color</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">style</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">ab</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">serving</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">namespace</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> default</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token key atrule">spec</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">components</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> color</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">ab</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">serving</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">type</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> model</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">serving</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">properties</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">protocol</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> tensorflow</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">predictors</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> model1</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token key atrule">replicas</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token number">1</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token key atrule">graph</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> my</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">model</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token key atrule">implementation</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> tensorflow</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token key atrule">modelUri</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> pvc</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain">//color</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">model/model/v2</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> style</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">ab</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">serving</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">type</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> model</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">serving</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">properties</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">protocol</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> tensorflow</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token comment" style="color:rgb(98, 114, 164)"># The model of style migration takes a long time, set the timeout time so that the request will not be timed out</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">timeout</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;10000&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">customRouting</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token comment" style="color:rgb(98, 114, 164)"># Specify custom Header</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token key atrule">header</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;style: transfer&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token comment" style="color:rgb(98, 114, 164)"># Specify custom routes</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token key atrule">serviceName</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;color-ab-serving&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">predictors</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> model2</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token key atrule">replicas</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token number">1</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token key atrule">graph</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> my</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">model</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token key atrule">implementation</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> tensorflow</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token key atrule">modelUri</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> pvc</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain">//style</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">model/model</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> ab</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">rest</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">serving</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">type</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> webservice</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">dependsOn</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> color</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">ab</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">serving</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> style</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">ab</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">serving</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">properties</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">image</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> fogdong/style</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">serving</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain">v1</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">exposeType</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> LoadBalancer</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">env</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> URL</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token key atrule">value</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> http</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain">//ambassador.vela</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">system.svc.cluster.local/seldon/default/color</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">ab</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">serving/v1/models/my</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">model</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain">predict</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">ports</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">port</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token number">3333</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token key atrule">expose</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token boolean important">true</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>After successful deployment, view the address of the model serving through <code>vela status &lt;app-name&gt; --endpoint</code>:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly bash"><div tabindex="0" class="prism-code language-bash codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token plain">$ vela status color-style-ab-serving --endpoint</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">+---------+---------------------------------+-------------------------------------------------------+</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token operator">|</span><span class="token plain"> CLUSTER </span><span class="token operator">|</span><span class="token plain">    REF</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">KIND/NAMESPACE/NAME</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain">     </span><span class="token operator">|</span><span class="token plain">                       ENDPOINT                        </span><span class="token operator">|</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">+---------+---------------------------------+-------------------------------------------------------+</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token operator">|</span><span class="token plain">         </span><span class="token operator">|</span><span class="token plain"> Service/vela-system/ambassador  </span><span class="token operator">|</span><span class="token plain"> http://47.251.36.228/seldon/default/color-ab-serving  </span><span class="token operator">|</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token operator">|</span><span class="token plain">         </span><span class="token operator">|</span><span class="token plain"> Service/vela-system/ambassador  </span><span class="token operator">|</span><span class="token plain"> https://47.251.36.228/seldon/default/color-ab-serving </span><span class="token operator">|</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token operator">|</span><span class="token plain">         </span><span class="token operator">|</span><span class="token plain"> Service/vela-system/ambassador  </span><span class="token operator">|</span><span class="token plain"> http://47.251.36.228/seldon/default/style-ab-serving  </span><span class="token operator">|</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token operator">|</span><span class="token plain">         </span><span class="token operator">|</span><span class="token plain"> Service/vela-system/ambassador  </span><span class="token operator">|</span><span class="token plain"> https://47.251.36.228/seldon/default/style-ab-serving </span><span class="token operator">|</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token operator">|</span><span class="token plain">         </span><span class="token operator">|</span><span class="token plain"> Service/default/ab-rest-serving </span><span class="token operator">|</span><span class="token plain"> tcp://47.251.5.97:3333                                </span><span class="token operator">|</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">+---------+---------------------------------+-------------------------------------------------------+</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>In this application, the two services have two addresses each, but the model service address of the second <code>style-ab-serving</code> is invalid because the model service is already pointed to the address of <code>color-ab-serving</code> . Again, we see how it works by requesting the test service.</p><p>First, without the header, the image changes from black and white to color:</p><p><img alt="alt" src="/assets/images/ab-request1-05b112438a860a7e590f9922add14c46.png"></p><p>Let&#x27;s add an image of an ocean wave as a style render:</p><p><img alt="alt" src="/assets/images/wave-25ac6d548667b746e5349d29e39b915e.jpg"></p><p>We add the Header of <code>style: transfer</code> to this request, and you can see that the city has become a wave style:</p><p><img alt="alt" src="/assets/images/ab-request2-9eb2e8760112fe66bcaf742fb97d4248.png"></p><p>We can also use an ink painting image as a style rendering:</p><p><img alt="alt" src="/assets/images/chinese-style-e6c8e27f2f4d33f707a58d3f274bde7a.jpg"></p><p>It can be seen that this time the city has become an ink painting style:</p><p><img alt="alt" src="/assets/images/ab-request3-09e8be352e5bef4a239b1ab2bfa211da.png"></p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="summary"></a>Summary<a class="hash-link" href="#summary" title="Direct link to heading">#</a></h2><p>Through KubeVela&#x27;s AI plug-in, it can help you to perform model training and model serving more conveniently.</p><p>In addition, together with KubeVela, we can also deliver the tested model to different environments through KubeVela&#x27;s multi-environment function, so as to realize the flexible deployment of the model.</p></div><footer class="row margin-vert--lg"><div class="col"><strong>Tags:</strong><a class="margin-horiz--sm" href="/blog/tags/kube-vela">KubeVela</a></div></footer></article><article class="margin-bottom--xl"><header><h2 class="margin-bottom--sm blogPostTitle_GeHD"><a href="/blog/2022/03/01/kubevela-generate-top-50-popular-resources-of-aws-using-100-lines-of-code">Generate top 50 popular resources of AWS using 100 lines of code</a></h2><div class="margin-vert--md"><time datetime="2022-03-01T00:00:00.000Z" class="blogPostDate_fNvV">March 1, 2022 Â· 6 min read</time></div><div class="avatar margin-vert--md"><a href="https://github.com/oam-dev/kubevela" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img src="https://kubevela.io/img/logo.svg" alt="Avery Qi (Tongji University) Zhengxi Zhou (Alibaba Cloud)"></a><div class="avatar__intro"><h4 class="avatar__name"><a href="https://github.com/oam-dev/kubevela" target="_blank" rel="noopener noreferrer">Avery Qi (Tongji University) Zhengxi Zhou (Alibaba Cloud)</a></h4><small class="avatar__subtitle">KubeVela Team</small></div></div></header><div class="markdown"><p>KubeVela currently supports AWS, Azure, GCP,  AliCloud, Tencent Cloud, Baidu Cloud, UCloud and other cloud vendors, and also provides <a href="https://kubevela.io/docs/next/platform-engineers/components/component-terraform" target="_blank" rel="noopener noreferrer">a quick and easy command line tool</a> to introduce cloud resources from cloud providers. But supporting cloud resources from cloud providers one by one in KubeVela is not conducive to quickly satisfying users&#x27; needs for cloud resources. This doc provides a solution to quickly introduce the top 50 most popular cloud resources from AWS in less than 100 lines of code.</p><p>We also expect users to be inspired by this article to contribute cloud resources for other cloud providers.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="where-are-the-most-popular-cloud-resources-on-aws"></a>Where are the most popular cloud resources on AWS?<a class="hash-link" href="#where-are-the-most-popular-cloud-resources-on-aws" title="Direct link to heading">#</a></h2><p>The official Terraform website provides Terraform modules for each cloud provider, for example, <a href="https://registry.terraform.io/namespaces/terraform-aws-modules" target="_blank" rel="noopener noreferrer">AWS cloud resource Terraform modules</a>. And the cloud resources are sorted by popularity of usage (downloads), for example, AWS VPC has 18.7 million downloads.</p><p>Through a simple analysis, we found that the data for the top 50 popular Terraform modules for AWS can be obtained by requesting <a href="https://registry.terraform.io/v2/modules?filter%5Bprovider%5D=aws&amp;include=latest-version&amp;page%5Bsize%5D=50&amp;page%5Bnumber%5D=1" target="_blank" rel="noopener noreferrer">https://registry.terraform.io/v2/modules?filter%5Bprovider%5D=aws&amp;include=latest-version&amp;page%5Bsize%5D=50&amp;page%5Bnumber%5D=1</a>.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="prerequisites"></a>Prerequisites<a class="hash-link" href="#prerequisites" title="Direct link to heading">#</a></h2><p>The code accepts two parameters.</p><ul><li>provider Name</li><li>The URL of the Terraform Modules corresponding to the provider</li></ul><p>For AWS, Provider Name should be â€œawsâ€ï¼Œcorresponding Terraform modules URL is<a href="https://registry.terraform.io/v2/modules?filter%5Bprovider%5D=aws&amp;include=latest-version&amp;page%5Bsize%5D=50&amp;page%5Bnumber%5D=1" target="_blank" rel="noopener noreferrer">Terraform Modules json API</a>(Searching top 50 popular resources for provider aws in <a href="https://registry.terraform.io/" target="_blank" rel="noopener noreferrer">Terraform Registry</a>).</p><p>You need to make sure the providerName(aws) and Modules links are correct before executing the code.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="executing-the-code"></a>Executing the code<a class="hash-link" href="#executing-the-code" title="Direct link to heading">#</a></h2><p>Then you can quickly bring in the top 50 most popular AWS cloud resources in bulk with the following 100 lines of code (filename gen.go).</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><div tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token plain">import (</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  &quot;encoding/json&quot;</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  &quot;fmt&quot;</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  &quot;io&quot;</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  &quot;log&quot;</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  &quot;net/http&quot;</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  &quot;os&quot;</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  &quot;os/exec&quot;</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  &quot;path/filepath&quot;</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  &quot;strings&quot;</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  &quot;github.com/pkg/errors&quot;</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">)</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">type TFDownload struct {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  Data     []DataItem     `json:&quot;data&quot;`</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  Included []IncludedItem `json:&quot;included&quot;`</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">}</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">type IncludedItem struct {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  Id         string     `json:&quot;id&quot;`</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  Attributes Attributes `json:&quot;attributes&quot;`</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">}</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">type DataItem struct {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  Attributes    Attributes    `json:&quot;attributes&quot;`</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  Relationships Relationships `json:&quot;relationships&quot;`</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">}</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">type Relationships struct {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  LatestVersion RelationshipLatestVersion `json:&quot;latest-version&quot;`</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">}</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">type RelationshipLatestVersion struct {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  Data RelationshipData `json:&quot;data&quot;`</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">}</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">type RelationshipData struct {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  Id string `json:&quot;id&quot;`</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">}</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">var errNoVariables = errors.New(&quot;failed to find main.tf or variables.tf in Terraform configurations&quot;)</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">type Attributes struct {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  Name        string `json:&quot;name&quot;`</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  Downloads   int    `json:&quot;downloads&quot;`</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  Source      string `json:&quot;source&quot;`</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  Description string `json:&quot;description&quot;`</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  Verified    bool   `json:&quot;verified&quot;`</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">}</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">func main() {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  if len(os.Args) &lt; 2 {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">     fmt.Println(&quot;Please provide the cloud provider name and an official Terraform modules URL&quot;)</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">     os.Exit(1)</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  }</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  providerName := os.Args[1]</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  terraformModulesUrl := os.Args[2]</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  resp, err := http.Get(terraformModulesUrl)</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  if err != nil {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">     log.Fatal(err)</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  }</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  defer resp.Body.Close()</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  body, err := io.ReadAll(resp.Body)</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  if err != nil {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">     log.Fatal(err)</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  }</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  var modules TFDownload</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  if err := json.Unmarshal(body, &amp;modules); err != nil {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">     fmt.Println(err.Error())</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">     os.Exit(1)</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  }</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  if _, err = os.Stat(providerName); err == nil {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">     if err := os.RemoveAll(providerName); err != nil {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        log.Fatal(err)</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">     }</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">     fmt.Printf(&quot;Successfully deleted existed directory %s\n&quot;, providerName)</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  }</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  if _, err = os.Stat(providerName); os.IsNotExist(err) {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">     if err := os.Mkdir(providerName, 0755); err != nil {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        if !os.IsExist(err) {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">           log.Fatal(err)</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        }</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        fmt.Printf(&quot;Successfully created directory %s\n&quot;, providerName)</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">     }</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  }</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  for _, module := range modules.Data {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">     var description string</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">     for _, attr := range modules.Included {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        if module.Relationships.LatestVersion.Data.Id == attr.Id {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">           description = attr.Attributes.Description</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        }</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">     }</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">     if description == &quot;&quot; {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        description = strings.ToUpper(providerName) + &quot; &quot; + strings.Title(module.Attributes.Name)</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">     }</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">     outputFile := fmt.Sprintf(&quot;%s/terraform-%s-%s.yaml&quot;, providerName, providerName, module.Attributes.Name)</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">     if _, err := os.Stat(outputFile); !os.IsNotExist(err) {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        continue</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">     }</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">     if providerName == &quot;aws&quot; &amp;&amp; (module.Attributes.Name == &quot;rds&quot; || module.Attributes.Name == &quot;s3-bucket&quot; ||</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        module.Attributes.Name == &quot;subnet&quot; || module.Attributes.Name == &quot;vpc&quot;) {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        continue</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">     }</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">     if err := generateDefinition(providerName, module.Attributes.Name, module.Attributes.Source, &quot;&quot;, description); err != nil {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        fmt.Println(err.Error())</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        os.Exit(1)</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">     }</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  }</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">}</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">func generateDefinition(provider, name, gitURL, path, description string) error {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  defYaml := filepath.Join(provider, fmt.Sprintf(&quot;terraform-%s-%s.yaml&quot;, provider, name))</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  cmd := fmt.Sprintf(&quot;vela def init %s --type component --provider %s --git %s.git --desc \&quot;%s\&quot; -o %s&quot;,</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">     name, provider, gitURL, description, defYaml)</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  if path != &quot;&quot; {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">     cmd = fmt.Sprintf(&quot;%s --path %s&quot;, cmd, path)</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  }</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  fmt.Println(cmd)</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  stdout, err := exec.Command(&quot;bash&quot;, &quot;-c&quot;, cmd).CombinedOutput()</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  if err != nil {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">     return errors.Wrap(err, string(stdout))</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  }</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  fmt.Println(string(stdout))</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  return nil</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>Executing the following command:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><div tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token plain">go run gen.go aws &quot;https://registry.terraform.io/v2/modules?filter%5Bprovider%5D=aws&amp;include=latest-version&amp;page%5Bsize%5D=50&amp;page%5Bnumber%5D=1&quot;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="explanation-for-the-code"></a>Explanation for the code<a class="hash-link" href="#explanation-for-the-code" title="Direct link to heading">#</a></h2><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="unmarshal-the-json-data-for-the-resources"></a>Unmarshal the json data for the resources<a class="hash-link" href="#unmarshal-the-json-data-for-the-resources" title="Direct link to heading">#</a></h3><p>Access the URL passed in by the user and parse the returned json data into the Go structure.</p><p>The json format corresponding to the resource is as follows.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><div tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token plain">{</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  &quot;data&quot;: [</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      &quot;type&quot;: &quot;modules&quot;,</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      &quot;id&quot;: &quot;23&quot;,</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      &quot;attributes&quot;: {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        &quot;downloads&quot;: 18440513,</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        &quot;full-name&quot;: &quot;terraform-aws-modules/vpc/aws&quot;,</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        &quot;name&quot;: &quot;vpc&quot;,</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        &quot;namespace&quot;: &quot;terraform-aws-modules&quot;,</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        &quot;owner-name&quot;: &quot;&quot;,</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        &quot;provider-logo-url&quot;: &quot;/images/providers/aws.png&quot;,</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        &quot;provider-name&quot;: &quot;aws&quot;,</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        &quot;source&quot;: &quot;https://github.com/terraform-aws-modules/terraform-aws-vpc&quot;,</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        &quot;verified&quot;: true</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      },</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      &quot;relationships&quot;: {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        &quot;latest-version&quot;: {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">          &quot;data&quot;: {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            &quot;id&quot;: &quot;142143&quot;,</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            &quot;type&quot;: &quot;module-versions&quot;</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">          }</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        }</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      },</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      &quot;links&quot;: {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        &quot;self&quot;: &quot;/v2/modules/23&quot;</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      }</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    },</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    ...</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  ],</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  &quot;included&quot;: [</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      &quot;type&quot;: &quot;module-versions&quot;,</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      &quot;id&quot;: &quot;36806&quot;,</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      &quot;attributes&quot;: {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        &quot;created-at&quot;: &quot;2020-01-03T11:35:36Z&quot;,</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        &quot;description&quot;: &quot;Terraform module Terraform module for creating AWS IAM Roles with heredocs&quot;,</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        &quot;downloads&quot;: 260030,</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        &quot;published-at&quot;: &quot;2020-02-06T06:26:08Z&quot;,</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        &quot;source&quot;: &quot;&quot;,</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        &quot;tag&quot;: &quot;v2.0.0&quot;,</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        &quot;updated-at&quot;: &quot;2022-02-22T00:45:44Z&quot;,</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        &quot;version&quot;: &quot;2.0.0&quot;</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      },</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      &quot;links&quot;: {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        &quot;self&quot;: &quot;/v2/module-versions/36806&quot;</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      }</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    },</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    ...</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  ],</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  ...</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>In the json data corresponding to Modules, we only care about two key-value pairs, viz.</p><ul><li>data: A list containing the names and properties of Modules</li><li>Included: Information about the specific version of Modules filtered out</li></ul><p>In this case, for each Module element in data, resolve its attributes, Id and the id corresponding to the latest-version in relationship; for each Module version element in Included, resolve its attributes and Id.</p><p>The attributes are further resolved as follows five items: </p><ul><li>Name</li><li>Downloads</li><li>Source</li><li>Description</li><li>Verified</li></ul><p>The Go structure is named as <code>TFDownload </code>, The http library gets the json data and then parses the structure of the Terraform modules through the <code>json.Unmarshal</code>.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="generating-componentdefinitions-in-batch"></a>generating ComponentDefinitions in batch<a class="hash-link" href="#generating-componentdefinitions-in-batch" title="Direct link to heading">#</a></h3><ol><li>creating directory and component definitions</li></ol><p>After parsing, create a new folder in the current directory and name the folder as \&lt;provider name&gt;.</p><p>Iterate through the parsed data, and for each Module element, perform the following operations to generate the corresponding definition and documentation for it.</p><ol start="2"><li>Generate definition files</li></ol><p>Generate the definition file by reading the corresponding information from the module&#x27;s github repository using the following vela command.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><div tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token plain">vela def init {ModuleName} --type component --provider {providerName} --git {gitURL} --desc {description} -o {yamlFileName}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>Several items to be filled in the instruction are passed in from the parsed Module structure.</p><ul><li>gitURL: 	{Module.Attributes.Source}.git</li><li>description: If there are elements in <code>Included</code> which have the same ID with relationship.latest-version.ID, set the description as the corresponding description in <code>Included</code> elements, otherwise set the description as providerName+ModuleName. </li><li>yamlFileNameï¼šterraform-{providerName}-{Module.Attributes.Name}.yaml</li></ul><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="have-a-try"></a>Have a try?<a class="hash-link" href="#have-a-try" title="Direct link to heading">#</a></h2><p>There are also a number of cloud providers that offer a wealth of Terraform modules, such as</p><p>GCP: <a href="https://registry.terraform.io/namespaces/terraform-google-modules" target="_blank" rel="noopener noreferrer">https://registry.terraform.io/namespaces/terraform-google-modules</a></p><p>Alibaba Cloud: <a href="https://registry.terraform.io/namespaces/terraform-alicloud-modules" target="_blank" rel="noopener noreferrer">https://registry.terraform.io/namespaces/terraform-alicloud-modules</a></p><p>Do you want to extend cloud resources for your current or favorite cloud provider for KubeVela as well?</p></div><footer class="row margin-vert--lg"><div class="col"><strong>Tags:</strong><a class="margin-horiz--sm" href="/blog/tags/terraform">Terraform</a></div></footer></article><article class="margin-bottom--xl"><header><h2 class="margin-bottom--sm blogPostTitle_GeHD"><a href="/blog/2022/01/27/blog-1.2">KubeVela v1.2 - Focused on Developer Experience, Simplified Multi-Cluster Application Delivery</a></h2><div class="margin-vert--md"><time datetime="2022-01-27T00:00:00.000Z" class="blogPostDate_fNvV">January 27, 2022 Â· 12 min read</time></div><div class="avatar margin-vert--md"><a href="https://github.com/oam-dev/kubevela" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img src="https://kubevela.io/img/logo.svg" alt="KubeVela Maintainers"></a><div class="avatar__intro"><h4 class="avatar__name"><a href="https://github.com/oam-dev/kubevela" target="_blank" rel="noopener noreferrer">KubeVela Maintainers</a></h4><small class="avatar__subtitle">KubeVela Team</small></div></div></header><div class="markdown"><p>As the cloud native technologies grows continuously, more and more infrastructure capabilities are becoming standardized PaaS or SaaS products. To build a product you don&#x27;t need a whole team to do it nowadays. Because there are so many services that can take roles from software developing, testing to infrastructure operations. As driven the culture of agile development and cloud native technologies, more and more roles can be shifted left to developers, e.g. testing, monitoring, security. As emphasized by the DevOps concepts, it can be done in the development phase for the work of monitoring, security, and operations via open source projects and cloud services. Nonetheless, this also creates huge challenges to developers, as they might lack the control of diverse products and complex APIs. Not only do they have to make choices, but also they need to understand and coordinate the complex, heterogeneous infrastructure capabilities in order to satisfy the fast-changing requirements of the business.</p><p>This complexity and uncertainty has exacerbated the developer experience undoubtedly, reducing the delivery efficiency of business system, increasing the operational risks. The tenet of developer experience is simplicity and efficiency. Not only the developers but also the enterprises have to choose the better developer tools and platforms to achieve this goal. This is also the focus of KubeVela v1.2 and upcoming release that to build a modern platform based on cloud native technologies and covering development, delivery, and operations. We can see from the following diagram of KubeVela architecture that developers only need to focus on applications per se, and use differentiated operational and delivery capabilities around the applications.</p><p><img src="https://static.kubevela.net/images/1.2/architecture.jpg" alt="image.png">
pic 1. KubeVela Architecture</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="oam--kubevela-history"></a>OAM &amp; KubeVela History<a class="hash-link" href="#oam--kubevela-history" title="Direct link to heading">#</a></h2><p>Let&#x27;s retrospect the history of OAM and KubeVela to understand how it is formed this way:</p><ul><li><strong>OAMï¼ˆOpen Application Modelï¼‰birth and growth</strong></li></ul><p>To create simplicity in a complex world, the first problem we need to solve is how to make standard abstractions? OAM creatively proposes two ways of separation: separation between applications and resources, and separation between development and operation (in ideal world the operation can be fully automated). It is a cloud native application specification which provides everything-as-a-service, complete modularity design. The spec has been getting tractions among major vendors all over the world since it&#x27;s been announced. Because we all share a common goal -- To reduce learning curve and provide application lego-style invention for developers.</p><ul><li><strong>v1.0 release of KubeVela, bringing the OAM spec implementation</strong></li></ul><p>With the application specification as the guidance, advanced community users can create their own tools to build practical solutions. But it is unaccessible to most developers though. KubeVela was born as the community standard implementation to solve this problem. It absorbs the good parts from latest Kubernetes community development. It provides automated, idempotent, reliable application rollout controllers. With its features, KubeVela can empower developers to quickly deploy OAM-compliant applications.</p><ul><li><strong>v1.1 release of KubeVela, provides delivery workflow, making multi-cluster rollout controlled and simplified</strong></li></ul><p>As more and more enterprises adopt the cloud, hybrid and distributed cloud will certainly become the future norm. KubeVela has been designed and built based on hybrid cloud infrastructure as a modern application management system. We anticipate that the architecture of modern enterprise applications will be heterogenous considering factors of availability, performance, data security, etc. In KubeVela 1.1, we adds new feature to achieve programmable delivery workflow. It natively fits the multi-cluster architecture to provide modern multi-cluster application rollout.</p><p>By the time of 2022, on the road to serve developers, KubeVela has gone to the fourth phase. It is going to empower developers to do multi-cluster rollout way more easily. In the following we will dissect its changes:</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="core-features-in-v12-release"></a>Core Features in v1.2 Release<a class="hash-link" href="#core-features-in-v12-release" title="Direct link to heading">#</a></h2><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="the-new-gui-project-velaux"></a>The new GUI project: VelaUX<a class="hash-link" href="#the-new-gui-project-velaux" title="Direct link to heading">#</a></h3><p>It is the best choice to reduce developer learning curve by  providing an easy-to-use UI console. Since the inception, KubeVela community has been asking for UI. With the v1.2 release, it has finally come. Providing GUI will help developers organize and compose heterogeneous aplications in a standard way. This will help them analyze and discover business obstacles quicker.</p><p><a href="https://github.com/oam-dev/velaux" target="_blank" rel="noopener noreferrer">VelaUX</a> is the frontend project of KubeVela with extensible core design. It introduces low-code experience for users to drag-and-drop form that takes user input based on dynamic components. To achieve this we have designed the frontend description spec <a href="https://kubevela.io/docs/reference/ui-schema" target="_blank" rel="noopener noreferrer">UISchema</a> with <a href="https://kubevela.io/docs/platform-engineers/oam/x-definition" target="_blank" rel="noopener noreferrer">X-Definition</a>, and multi-dimensional query language <a href="https://kubevela.io/docs/platform-engineers/system-operation/velaql" target="_blank" rel="noopener noreferrer">VelaQL</a>. This design makes the foundation for the heterogenous application delivery architecture of KubeVela.</p><p>From GUI, users can manage addons, connect Kubernetes clusters, distribute delivery targets, set up environments and deploy all kinds of apps, monitor runtime status, achieve full lifecycle management of application delivery.</p><p><img src="https://static.kubevela.net/images/1.2/dashboard.jpeg" alt="image.png">
pic 2. KubeVela Application Dashboard</p><p>For the new terms in GUI, please refer to <a href="https://kubevela.io/docs/next/getting-started/core-concept" target="_blank" rel="noopener noreferrer">Core Concepts</a> documentation to learn more details.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="unified-multi-cluster-control"></a>Unified Multi-Cluster Control<a class="hash-link" href="#unified-multi-cluster-control" title="Direct link to heading">#</a></h3><p>KubeVela will manage N Kubernetes clusters, N cloud vendor services in a big unified infrastructure pool. From that our developers can set up different environments based on business requirements, workflow policies, team collaboration needs, etc. This will create separate environment workspaces from big infrastructure resource pool. One application can be deployed into multiple environments, and environments are isolated from each other in both management and runtime.</p><p><img src="https://static.kubevela.net/images/1.2/multiple-cluster.png" alt="image.png">
pic 3. KubeVela Application Status</p><p>As shown above, an application can be deployed to default environments and other custom environments such as test or prod. Each environment can include multiple delivery targets. Each delivery target indicates an independent, separate Kubernetes cluster.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="heterogeneous-application-architecture"></a>Heterogeneous Application Architecture<a class="hash-link" href="#heterogeneous-application-architecture" title="Direct link to heading">#</a></h3><p>In terms of cloud native technologies, we have many options to pick for build application delivery solutions. Based on Kubernetes, we can use mature technologies like Helm Chart to delivery middleware and third-party open source softwares. We can deliver enterprise business applications via container images. We can also use OpenYurt to deliver and mange edge applications. Based on the open technologies of cloud services, we can deliver database, message queues, cache, etc. middleware, including operational features like logging, monitoring.</p><p>With so many options, KubeVela adopts OAM as the standard application definition to manage heterogeneous application architecture uniformly. KubeVela provides highly extensible delivery core engine. Users can use built-in or install more plugins to extend the platform, and manage application deliveries in a consistent way. On top of KubeVela, what users see is the modular, everything-as-a-service control plane.</p><p><img src="https://static.kubevela.net/images/1.2/cloud-resource.png" alt="image.png">
pic 4. Cloud Resources Deploy</p><p>As shown above, we can tell that in the application management page users can conveniently deliver cloud resources. Developers can read the following docs to understand the full delivery process of heterogeneous application architecture:</p><ol><li><a href="https://kubevela.io/docs/next/deliver-app/webservice" target="_blank" rel="noopener noreferrer">Deliver Docker Image</a></li><li><a href="https://kubevela.io/docs/next/deliver-app/helm" target="_blank" rel="noopener noreferrer">Deliver Helm Chart</a></li><li><a href="https://kubevela.io/docs/next/deliver-app/k8s-object" target="_blank" rel="noopener noreferrer">Deliver Kubernetes Resources</a></li><li><a href="https://kubevela.io/docs/next/deliver-app/consume-cloud-services" target="_blank" rel="noopener noreferrer">Deliver cloud resources</a></li></ol><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="extension-system"></a>Extension System<a class="hash-link" href="#extension-system" title="Direct link to heading">#</a></h3><p>KubeVela has been designed as an extensible system from the very beginning. The aforementioned heterogeneous application architecture can be achieved via KubeVela&#x27;s extension system. It can be extended via standard interfaces and plugin as many capabilities as you want. This will match the differentiated requirements of enterprises while reducing the cognitive burden incurred in learning new things. KubeVela&#x27;s extension system includes component types, operational traits, workflow types, delivery policies, etc. In current release, we have the addon management system. An addon packages the extension capabilities for easy distribution.</p><p><img src="https://static.kubevela.net/images/1.2/addon.png" alt="image.png">
pic 5. KubeVela Addons</p><p>Currently we provide an official catalog with pre-packaged addons shown as above. Meanwhile in the experimental catalog repo we can collaborating with community users to create more capabilities.</p><p>By now, KubeVela has grown into an application delivery platform that serve developers directly. What enterprise scenarios can we use KubeVela for? In the following we list a couple of common scenarios:</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="enterprise-software-delivery-solutions"></a>Enterprise Software Delivery Solutions<a class="hash-link" href="#enterprise-software-delivery-solutions" title="Direct link to heading">#</a></h2><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="multi-cluster-devops"></a>Multi-Cluster DevOps<a class="hash-link" href="#multi-cluster-devops" title="Direct link to heading">#</a></h3><p>Today many enterprise software delivery looks like the following diagram. They use the compute resources from cloud vendors for both the demo and production environments. But they use their in-house server farm for the development or testing environments. If any business applications have multi-region disaster recovery requirements, then production environments can span multiple regions or even clouds.</p><p><img src="https://static.kubevela.net/images/1.2/devops-en.png" alt="image.png">
pic 6. DevOps Pipeline</p><p>For basic DevOps workflow, it includes code hosting, CI/CD process. KubeVela can provide support for CD process. To enterprises the following are the practical steps:</p><ol><li>Prepare local and cloud resources according to real needs. Make sure local and cloud resources are connected in the same network plane for unified resource management.</li><li>Deploy KubeVela into the production environment and ensure its accessibility.</li><li>Install DevOps toolchain like Gitlab, Jenkins, Sonar via KubeVela. Usually the accessability of code hosting and developer toolchain are critical and we must deploy them to production environments. Unless you local clusters can ensure accessibility, can hope the business code to exist in local environment, then you can deploy them to local clusters.</li><li>Setup local development environments via KubeVela, deploy testing middleware in local. Setup cloud middleware in production environments. </li><li>Setup business code CI piplines via Jenkins. Generates Docker image and send it to KubeVela to do multi-environment deployment. This will make up an end-to-end application delivery workflow.</li></ol><p>Using KubeVela multi-cluster DevOps solution will provide the following advantages:</p><ol><li>Developers do not need to know any Kubernetes knowledge to achieve heterogeneous cloud-native application delivery.</li><li>Unified multi-cluster, multi-environment management in a single control plane. Natively deploy multi-cluster applications.</li><li>Unified application management mode, regardless of business applications or developer toolchain.</li><li>Flexible workflow to help enterprises to glue various software delivery processes in a single workflow.</li></ol><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="unified-management-of-heterogeneous-environments"></a>Unified Management of Heterogeneous Environments<a class="hash-link" href="#unified-management-of-heterogeneous-environments" title="Direct link to heading">#</a></h3><p>Different enterprises face different problems and requirements of infrastructure and business. On the infrastructure side, enterprises could build in-house private cloud, yet buy some public cloud resources, and own some edge devices. On the business side, the variance of scale and requirements will lead to multi-cloud, multi-region application architecture, while keeping some legacy systems. On the developer side, developing software will need various environments such as development, testing, staging, production. On the management side, different business teams need isolation from each other, while opening up connection between some business applications.
â€‹</p><p>In the past, it was very easy to become fragmented between different business teams inside enterprises. This fragmentation exists in: toolchain, technical architecture, business management. We take this into account while being innovative in technologies. KubeVela brings a new solution that pursues unified management and extensible architecture with good compatibility.</p><ul><li>On the infrastructure side, we support different API formats including Kubernetes API, cloud APIs, and custom APIs to model all kinds of the infrastructure.</li><li>On the business architecture side, the application model is open and platform agnostic. KubeVela provides the ability to connect and empower businesses.</li><li>On the Developer toolchain side, there might be different toolchain and artifacts in the enterprises. KubeVela provides the extension mechanism and standard models to combine different kinds of artifacts into a standardized delivery workflow. Surely, its standards are shifting left and empowering enterprises to unify toolchain management. You don&#x27;t need to concern whether you are using Gitlab or Jenkins because KubeVela can integrate them both.</li><li>On the operations side, the operational capabilities and toolchain solutions can be unified under KubeVela standards in the enterprises. Moreover, the community operational capabilities can be shared and reused easily via KubeVela extensions.</li></ul><p>Thus, KubeVela can be used to connect different stages inside the enterprises, and unify all capabilities in a single platform. It is a practical and future-proof solution.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="enterprise-internal-application-platform"></a>Enterprise Internal Application Platform<a class="hash-link" href="#enterprise-internal-application-platform" title="Direct link to heading">#</a></h3><p>Many enterprises that has enough development power will choose to build internal application platforms. The main reason is that they can customize the platform to make it very easy for their use cases. In the past we can see there are many PaaS platforms born out of Cloud Foundry. We all know the stereotypes of application platforms will not satisfy all enterprises. If the application package format and delivery workflow can standardized inside enterprises, then all users need to do is to fill the image name. However, in traditional PaaS platforms developers have to understand a bunch of so-called general concepts. For example, if an enterprise want to deploy AI applications, and there is some difference for AI application architecture, then we have to create such AI PaaS, and enterprises have to pay more fees and learn more concepts.</p><p>Therefore, when general products couldn&#x27;t satisfy the needs of enterprises, they will consider develop one on their own. But it takes so much resources to build an internal platform from scratch. Sometimes it even surpasses the investment of their core business. This is not a feasible solution.</p><p>With above introduction, are you more familiar with the motivations and history of KubeVela? There is no such a product to be the silver bullet. But our goal is to create a standardized model to empower more and more enterprises and developers to participate in the path towards building simple and efficient developer tools. KubeVela is still in early development phase. We still hope you can join us to develop it together. We want to thank <a href="https://github.com/oam-dev/kubevela/graphs/contributors" target="_blank" rel="noopener noreferrer">the 100+ contributors</a> who contributed to KubeVela.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="join-the-community"></a>Join the Community<a class="hash-link" href="#join-the-community" title="Direct link to heading">#</a></h2><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="collaborate-on-oam-specification"></a>Collaborate on OAM Specification<a class="hash-link" href="#collaborate-on-oam-specification" title="Direct link to heading">#</a></h3><p>OAM spec is the cornerstone of modern application platform architecture. Currently, OAM spec is driven by implementation of KubeVela for future improvement while the spec didn&#x27;t rely on KubeVela. We highly encourage cloud vendors, platform builders, and end users to join us to define OAM spec together. We highly appreciate that vendors like Tencent, China Telecom, China Unicom have supported OAM spec and started collaborative work. Every person and organization are welcome to share your ideas, suggestions, and thoughts.</p><p>Go the <a href="https://github.com/oam-dev/spec" target="_blank" rel="noopener noreferrer">Community repo</a>.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="collaborate-on-addon-ecosystem"></a>Collaborate on Addon ecosystem<a class="hash-link" href="#collaborate-on-addon-ecosystem" title="Direct link to heading">#</a></h3><p>As mentioned above, we have created the addon extension system, and encourage community developers to contribute your tools, and share your thoughts.</p><ul><li>Go to the <a href="https://github.com/oam-dev/catalog" target="_blank" rel="noopener noreferrer">Community repo</a></li><li><a href="https://kubevela.io/docs/platform-engineers/addon/intro" target="_blank" rel="noopener noreferrer">How to contribute an addon</a></li></ul><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="contribute-cloud-resources"></a>Contribute Cloud Resources<a class="hash-link" href="#contribute-cloud-resources" title="Direct link to heading">#</a></h3><p>KubeVela integrated Terraform Module with <a href="https://github.com/oam-dev/terraform-controller" target="_blank" rel="noopener noreferrer">Terraform controller</a> to extend cloud resources. We have supported <a href="https://kubevela.io/docs/end-user/components/cloud-services/provider-and-consume-cloud-services" target="_blank" rel="noopener noreferrer">several cloud resources</a>, and encourage community developers or cloud providers to contribute more.</p><p>Go to <a href="https://kubevela.io/docs/platform-engineers/components/component-terraform" target="_blank" rel="noopener noreferrer">contribute cloud resource</a>.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="provide-your-feedback"></a>Provide Your Feedback<a class="hash-link" href="#provide-your-feedback" title="Direct link to heading">#</a></h3><p>We highly welcome everyone to participate in the KubeVela community discussion whether you want to know more or contribute code!</p><p>Go to <a href="https://github.com/oam-dev/kubevela" target="_blank" rel="noopener noreferrer">Community repo</a>.</p><blockquote><p>KubeVela  is a CNCF sandbox project. Learn more by reading the <a href="https://kubevela.io/docs/install" target="_blank" rel="noopener noreferrer">official documentation</a></p></blockquote></div><footer class="row margin-vert--lg"><div class="col"><strong>Tags:</strong><a class="margin-horiz--sm" href="/blog/tags/dev-ops">DevOps</a></div></footer></article><article class="margin-bottom--xl"><header><h2 class="margin-bottom--sm blogPostTitle_GeHD"><a href="/blog/2021/10/10/kubevela-gitops">Using GitOps + KubeVela for Application Continuous Delivery</a></h2><div class="margin-vert--md"><time datetime="2021-10-10T00:00:00.000Z" class="blogPostDate_fNvV">October 10, 2021 Â· 13 min read</time></div><div class="avatar margin-vert--md"><a href="https://github.com/oam-dev/kubevela" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img src="https://kubevela.io/img/logo.svg" alt="Tianxin Dong"></a><div class="avatar__intro"><h4 class="avatar__name"><a href="https://github.com/oam-dev/kubevela" target="_blank" rel="noopener noreferrer">Tianxin Dong</a></h4><small class="avatar__subtitle">KubeVela Team</small></div></div></header><div class="markdown"><p>KubeVela is a simple, easy-to-use, and highly extensible cloud-native application platform. It can make developers deliver microservices applications easily, without knowing Kubernetes details.</p><p>KubeVela is based on OAM model, which naturally solves the orchestration problems of complex resources. It means that KubeVela can manage complex large-scale applications with GitOps. Convergence of team and system size after the system complexity problem.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="what-is-gitops"></a>What is GitOps<a class="hash-link" href="#what-is-gitops" title="Direct link to heading">#</a></h2><p>GitOps is a modern way to do continuous delivery. Its core idea is to have a Git repository which contains environmental and application configurations. An automated process is also needed for sync the config to cluster.</p><p>By changing the files in repository, developers can apply the applications automatically. The benefits of applying GitOps include:</p><ul><li>Increased productivity. Continuous delivery can speed up the time of deployment.</li><li>Lower the barrier for developer to deploy. By pushing code instead of container configuration, developers can easily deploy Kubernetes without knowing its internal implementation.</li><li>Trace the change records. Managing the cluster with Git makes every change traceable, enhancing the audit trail.</li><li>Recover the cluster with Git&#x27;s rollback and branch.</li></ul><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="gitops-with-kubevela"></a>GitOps with KubeVela<a class="hash-link" href="#gitops-with-kubevela" title="Direct link to heading">#</a></h2><p>KubeVela as an declarative application delivery control plane can be naturally used in GitOps approach, and this will provide below extra bonus to end users alongside with GitOps benefits:</p><ul><li>application delivery workflow (CD pipeline)<ul><li>i.e. KubeVela supports pipeline style application delivery process in GitOps, instead of simply declaring final status;</li></ul></li><li>handling deployment dependencies and designing typologies (DAG);</li><li>unified higher level abstraction atop various GitOps tools&#x27; primitives;</li><li>declare, provision and consume cloud resources in unified application definition;</li><li>various out-of-box deployment strategies (Canary, Blue-Green ...);</li><li>various out-of-box hybrid/multi-cloud deployment policies (placement rule, cluster selectors etc.);</li><li>Kustomize-style patch for multi-env deployment without the need to learn Kustomize at all;</li><li>... and much more.</li></ul><p>In this section, we will introduce steps of using KubeVela directly in GitOps approach.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="gitops-workflow"></a>GitOps workflow<a class="hash-link" href="#gitops-workflow" title="Direct link to heading">#</a></h2><p>The GitOps workflow is divided into CI and CD:</p><ul><li>CI(Continuous Integration): Continuous integration builds code and images, and pushes images to the registry. There are many CI tools like GitHub Action, Travis, Jenkins and so on. In this article, we use GitHub Action for CI. You can also use other CI tools. KubeVela can connect CI processes under any tool around GitOps.</li><li>CD(Continuous Delivery): Continuous delivery automatically updates the configuration in the cluster. For example, update the latest images in the registry to the cluster.<ul><li>Currently there are two main CD modes:<ul><li>Push-based: Push mode CD is mainly accomplished by configuring CI pipeline. In this way, the access key of the cluster is shared with CI so that the CI pipeline can push changes to the cluster. For this mode, please refer to our previous blog post: <a href="/blog/2021/09/02/kubevela-jenkins-cicd">Using Jenkins + KubeVela for Application Continuous Delivery</a>.</li><li>Pull-based: Pull mode CD listens for changes to the repository (code repository or configuration repository) in the cluster and synchronizes those changes to the cluster. In this way, the cluster actively pulls the update, thus avoiding the problem of exposing the secret key. This article will introduce using KubeVela and GitOps in pull mode.</li></ul></li></ul></li></ul><p>This article will separate into two perspectives:</p><ol><li><p>For platform administrators/SREs, they can update the config in Git repo. It will trigger automated re-deployment.</p></li><li><p>For developers, they can update the app source code and then push it to Git. It will trigger building latest image and re-deployment.</p></li></ol><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="for-platform-administratorssres"></a>For platform administrators/SREs<a class="hash-link" href="#for-platform-administratorssres" title="Direct link to heading">#</a></h2><p>Platform administrators/SREs prepares the Git repo for operational config. Every config change will be traceable by that. KubeVela will watch the repo and apply changes to the clusters.</p><p><img alt="alt" src="/assets/images/ops-flow-8bec0d06df6baf12234cfe6c18bff438.jpg"></p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="setup-config-repository"></a>Setup Config Repository<a class="hash-link" href="#setup-config-repository" title="Direct link to heading">#</a></h2><blockquote><p>The configuration files are from the <a href="https://github.com/oam-dev/samples/tree/master/09.GitOps_Demo/for-SREs" target="_blank" rel="noopener noreferrer">Example Repo</a>.</p></blockquote><p>In this example, we will deploy an application and a database, the application uses the database to store data.</p><p>The structure of the config repository looks below:</p><ul><li>The <code>clusters/</code> contains the GitOps config. It will command KubeVela to watch the specified repo and apply latest changes.</li><li>The <code>apps/</code> contains the Application yaml for deploying the user-facing app.</li><li>The <code>infrastructure/</code> contains infrastructure tools, i.e. MySQL database.</li></ul><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly shell"><div tabindex="0" class="prism-code language-shell codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token plain">â”œâ”€â”€ apps</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">â”‚Â Â  â””â”€â”€ my-app.yaml</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">â”œâ”€â”€ clusters</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">â”‚Â Â  â”œâ”€â”€ apps.yaml</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">â”‚Â Â  â””â”€â”€ infra.yaml</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">â””â”€â”€ infrastructure</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    â””â”€â”€ mysql.yaml</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><blockquote><p>KubeVela recommends using the directory structure above to manage your GitOps repository. <code>clusters/</code> holds the associated KubeVela GitOps configuration that need to be applied to cluster manually, <code>apps/</code> holds your application and <code>infrastructure/</code> holds your base configuration. By separating applications from basic configurations, you can manage your deployment environment more reasonably and isolate application changes.</p></blockquote><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="directory-clusters"></a>Directory <code>clusters/</code><a class="hash-link" href="#directory-clusters" title="Direct link to heading">#</a></h4><p>The <code>clusters/</code> is the initialize configuration directory for KubeVela GitOps.</p><p>Below is how the <code>clusters/infra.yaml</code> looks like:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly yaml"><div tabindex="0" class="prism-code language-yaml codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token key atrule">apiVersion</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> core.oam.dev/v1beta1</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token key atrule">kind</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> Application</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token key atrule">metadata</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> infra</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token key atrule">spec</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">components</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> database</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">config</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">type</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> kustomize</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">properties</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">repoType</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> git</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token comment" style="color:rgb(98, 114, 164)"># replace it with your repo url</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">url</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> https</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain">//github.com/FogDong/KubeVela</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">GitOps</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">Infra</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">Demo</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token comment" style="color:rgb(98, 114, 164)"># replace it with your git secret if it&#x27;s a private repo</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token comment" style="color:rgb(98, 114, 164)"># secretRef: git-secret</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token comment" style="color:rgb(98, 114, 164)"># the pull interval time, set to 10m since the infrastructure is steady</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">pullInterval</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> 10m</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">git</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token comment" style="color:rgb(98, 114, 164)"># the branch name</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token key atrule">branch</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> main</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token comment" style="color:rgb(98, 114, 164)"># the path to sync</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">path</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> ./infrastructure</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p><code>apps.yaml</code> and <code>infra.yaml</code> in <code>clusters/</code> are similar. Their difference is to watch different directories. In <code>apps.yaml</code>, the <code>properties.path</code> will be <code>./apps</code>.</p><p>Apply the files in <code>clusters/</code> manually. They will sync the files in <code>infrastructure/</code> and <code>apps/</code> dir of the Git repo.</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="directory-apps"></a>Directory <code>apps/</code><a class="hash-link" href="#directory-apps" title="Direct link to heading">#</a></h4><p>The file in <code>apps/</code> is a simple application with database information and Ingress. The app serves HTTP service and connects to a MySQL database. In the &#x27;/&#x27; path, it will display the version in the code; in the <code>/db</code> path, it will list the data in database.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly yaml"><div tabindex="0" class="prism-code language-yaml codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token key atrule">apiVersion</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> core.oam.dev/v1beta1</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token key atrule">kind</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> Application</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token key atrule">metadata</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> my</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">app</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">namespace</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> default</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token key atrule">spec</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">components</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> my</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">server</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">type</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> webservice</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">properties</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token key atrule">image</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> &lt;your image address</span><span class="token punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)"># {&quot;$imagepolicy&quot;: &quot;default:apps&quot;}</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token key atrule">port</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token number">8088</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token key atrule">env</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> DB_HOST</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token key atrule">value</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> mysql</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">cluster</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">mysql.default.svc.cluster.local</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token number">3306</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> DB_PASSWORD</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token key atrule">valueFrom</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">              </span><span class="token key atrule">secretKeyRef</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> mysql</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">secret</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                </span><span class="token key atrule">key</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> ROOT_PASSWORD</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">traits</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">type</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> ingress</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token key atrule">properties</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token key atrule">domain</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> testsvc.example.com</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token key atrule">http</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">              </span><span class="token key atrule">/</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token number">8088</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>This is an Application binds with Traits Ingress. In this way, the underlying Deployment, Service, and Ingress can be brought together in a single file, making it easier to manage the application.</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="directory-infrastructure"></a>Directory <code>infrastructure/</code><a class="hash-link" href="#directory-infrastructure" title="Direct link to heading">#</a></h4><p>The <code>infrastructure/</code> contains the config of some infrastructures like database. In the following, we will use <a href="https://github.com/bitpoke/mysql-operator" target="_blank" rel="noopener noreferrer">MySQL operator</a> to deploy a MySQL cluster.</p><blockquote><p>Notice that there must be a secret in your cluster with MySQL password specified in key <code>ROOT_PASSWORD</code>.</p></blockquote><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly yaml"><div tabindex="0" class="prism-code language-yaml codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token key atrule">apiVersion</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> core.oam.dev/v1beta1</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token key atrule">kind</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> Application</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token key atrule">metadata</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> mysql</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">namespace</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> default</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token key atrule">spec</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">components</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> mysql</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">controller</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">type</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> helm</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">properties</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token key atrule">repoType</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> helm</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token key atrule">url</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> https</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain">//presslabs.github.io/charts</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token key atrule">chart</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> mysql</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">operator</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token key atrule">version</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;0.4.0&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> mysql</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">cluster</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">type</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> raw</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">dependsOn</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> mysql</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">controller</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">properties</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token key atrule">apiVersion</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> mysql.presslabs.org/v1alpha1</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token key atrule">kind</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> MysqlCluster</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token key atrule">metadata</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> mysql</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">cluster</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token key atrule">spec</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token key atrule">replicas</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token number">1</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token comment" style="color:rgb(98, 114, 164)"># replace it with your secret</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token key atrule">secretName</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> mysql</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">secret</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>We use workflow in this Application. The first step is to deploy the MySQL controller, after the controller is running, the second step will deploy the MySQL cluster.</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="apply-the-files-in-clusters"></a>Apply the files in <code>clusters/</code><a class="hash-link" href="#apply-the-files-in-clusters" title="Direct link to heading">#</a></h4><p>After storing bellow files in the Git config repo, we need to apply the GitOps config files in <code>clusters/</code> manually.</p><p>First, apply the <code>clusters/infra.yaml</code> to cluster, we can see that the MySQL in <code>infrastructure/</code> is automatically deployed:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly shell"><div tabindex="0" class="prism-code language-shell codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token plain">kubectl apply -f clusters/infra.yaml</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly shell"><div tabindex="0" class="prism-code language-shell codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token plain">$ vela </span><span class="token function" style="color:rgb(80, 250, 123)">ls</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">APP     COMPONENT           TYPE        TRAITS  PHASE   HEALTHY STATUS  CREATED-TIME</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">infra   database-config     kustomize           running healthy         </span><span class="token number">2021</span><span class="token plain">-09-26 </span><span class="token number">20</span><span class="token plain">:48:09 +0800 CST</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">mysql   mysql-controller    helm                running healthy         </span><span class="token number">2021</span><span class="token plain">-09-26 </span><span class="token number">20</span><span class="token plain">:48:11 +0800 CST</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">â””â”€      mysql-cluster       raw                 running healthy         </span><span class="token number">2021</span><span class="token plain">-09-26 </span><span class="token number">20</span><span class="token plain">:48:11 +0800 CST</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>Apply the <code>clusters/apps.yaml</code> to cluster, we can see that the application in <code>apps/</code> is automatically deployed:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly shell"><div tabindex="0" class="prism-code language-shell codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token plain">kubectl apply -f clusters/apps.yaml</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly shell"><div tabindex="0" class="prism-code language-shell codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token plain">APP     COMPONENT           TYPE        TRAITS  PHASE   HEALTHY STATUS  CREATED-TIME</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">apps    apps                kustomize           running healthy         </span><span class="token number">2021</span><span class="token plain">-09-27 </span><span class="token number">16</span><span class="token plain">:55:53 +0800 CST</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">infra   database-config     kustomize           running healthy         </span><span class="token number">2021</span><span class="token plain">-09-26 </span><span class="token number">20</span><span class="token plain">:48:09 +0800 CST</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">my-app  my-server           webservice  ingress running healthy         </span><span class="token number">2021</span><span class="token plain">-09-27 </span><span class="token number">16</span><span class="token plain">:55:55 +0800 CST</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">mysql   mysql-controller    helm                running healthy         </span><span class="token number">2021</span><span class="token plain">-09-26 </span><span class="token number">20</span><span class="token plain">:48:11 +0800 CST</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">â””â”€      mysql-cluster       raw                 running healthy         </span><span class="token number">2021</span><span class="token plain">-09-26 </span><span class="token number">20</span><span class="token plain">:48:11 +0800 CST</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>By deploying the KubeVela GitOps config files, we now automatically apply the application and database in cluster.</p><p><code>curl</code> the Ingress of the app, we can see that the current version is <code>0.1.5</code> and the application is connected to the database successfully:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly shell"><div tabindex="0" class="prism-code language-shell codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token plain">$ kubectl get ingress</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">NAME        CLASS    HOSTS                 ADDRESS         PORTS   AGE</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">my-server   </span><span class="token operator">&lt;</span><span class="token plain">none</span><span class="token operator">&gt;</span><span class="token plain">   testsvc.example.com   </span><span class="token operator">&lt;</span><span class="token plain">ingress-ip</span><span class="token operator">&gt;</span><span class="token plain">    </span><span class="token number">80</span><span class="token plain">      162m</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">$ </span><span class="token function" style="color:rgb(80, 250, 123)">curl</span><span class="token plain"> -H </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;Host:testsvc.example.com&quot;</span><span class="token plain"> http://</span><span class="token operator">&lt;</span><span class="token plain">ingress-ip</span><span class="token operator">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">Version: </span><span class="token number">0.1</span><span class="token plain">.5</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">$ </span><span class="token function" style="color:rgb(80, 250, 123)">curl</span><span class="token plain"> -H </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;Host:testsvc.example.com&quot;</span><span class="token plain"> http://</span><span class="token operator">&lt;</span><span class="token plain">ingress-ip</span><span class="token operator">&gt;</span><span class="token plain">/db</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">User: KubeVela</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">Description: It&#x27;s a </span><span class="token builtin class-name" style="color:rgb(189, 147, 249)">test</span><span class="token plain"> user</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="modify-the-config-for-gitops-trigger"></a>Modify the config for GitOps trigger<a class="hash-link" href="#modify-the-config-for-gitops-trigger" title="Direct link to heading">#</a></h2><p>After the first deployment, we can modify the files in config repo to update the applications in the cluster.</p><p>Modify the domain of the application&#x27;s Ingress:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly yaml"><div tabindex="0" class="prism-code language-yaml codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token punctuation" style="color:rgb(248, 248, 242)">...</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">traits</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">type</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> ingress</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token key atrule">properties</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token key atrule">domain</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> kubevela.example.com</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token key atrule">http</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">              </span><span class="token key atrule">/</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token number">8089</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>Check the Ingress in cluster after a while:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly shell"><div tabindex="0" class="prism-code language-shell codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token plain">NAME        CLASS    HOSTS                 ADDRESS         PORTS   AGE</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">my-server   </span><span class="token operator">&lt;</span><span class="token plain">none</span><span class="token operator">&gt;</span><span class="token plain">   kubevela.example.com  </span><span class="token operator">&lt;</span><span class="token plain">ingress-ip</span><span class="token operator">&gt;</span><span class="token plain">    </span><span class="token number">80</span><span class="token plain">      162m</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>The host of the Ingress has been updated successfully!</p><p>In this way, we can edit the files in the Git repo to update the cluster.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="for-developers"></a>For developers<a class="hash-link" href="#for-developers" title="Direct link to heading">#</a></h2><p>Developers writes the application source code and push it to a Git repo (aka app repo). Once app repo updates, the CI will build the image and push it to the image registry. KubeVela watches the image registry, and updates the image in config repo. Finally, it will apply the config to the cluster.</p><p>User can update the configuration in the cluster automatically when the code is updated.</p><p><img alt="alt" src="/assets/images/dev-flow-e2153e9687ba8904dddea46db8aa7a85.jpg"></p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="setup-app-code-repository"></a>Setup App Code Repository<a class="hash-link" href="#setup-app-code-repository" title="Direct link to heading">#</a></h3><p>Setup a Git repository with source code and Dockerfile.</p><p>The app serves HTTP service and connects to a MySQL database. In the &#x27;/&#x27; path, it will display the version in the code; in the <code>/db</code> path, it will list the data in database.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly go"><div tabindex="0" class="prism-code language-go codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token plain">    http</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">HandleFunc</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">&quot;/&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">func</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">w http</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">ResponseWriter</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> r </span><span class="token operator">*</span><span class="token plain">http</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Request</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token boolean">_</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token boolean">_</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> fmt</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">Fprintf</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">w</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;Version: %s\n&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> VERSION</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    http</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">HandleFunc</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">&quot;/db&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">func</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">w http</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">ResponseWriter</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> r </span><span class="token operator">*</span><span class="token plain">http</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Request</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        rows</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> err </span><span class="token operator">:=</span><span class="token plain"> db</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">Query</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">&quot;select * from userinfo;&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> err </span><span class="token operator">!=</span><span class="token plain"> </span><span class="token boolean">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token boolean">_</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token boolean">_</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> fmt</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">Fprintf</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">w</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;Error: %v\n&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> err</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">for</span><span class="token plain"> rows</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">Next</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">var</span><span class="token plain"> username </span><span class="token builtin" style="color:rgb(189, 147, 249)">string</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">var</span><span class="token plain"> desc </span><span class="token builtin" style="color:rgb(189, 147, 249)">string</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            err </span><span class="token operator">=</span><span class="token plain"> rows</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">Scan</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token operator">&amp;</span><span class="token plain">username</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token operator">&amp;</span><span class="token plain">desc</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> err </span><span class="token operator">!=</span><span class="token plain"> </span><span class="token boolean">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                </span><span class="token boolean">_</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token boolean">_</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> fmt</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">Fprintf</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">w</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;Scan Error: %v\n&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> err</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token boolean">_</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token boolean">_</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> fmt</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">Fprintf</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">w</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;User: %s \nDescription: %s\n\n&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> username</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> desc</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> err </span><span class="token operator">:=</span><span class="token plain"> http</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">ListenAndServe</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">&quot;:8088&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token boolean">nil</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"> err </span><span class="token operator">!=</span><span class="token plain"> </span><span class="token boolean">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token function" style="color:rgb(80, 250, 123)">panic</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">err</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">Error</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>In this tutorial, we will setup a CI pipeline using GitHub Actions to build the image and push it to a registry. The code and configuration files are from the <a href="https://github.com/oam-dev/samples/tree/master/09.GitOps_Demo/for-developers/app-code" target="_blank" rel="noopener noreferrer">Example Repo</a>.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="create-git-secret-for-kubevela-committing-to-config-repo"></a>Create Git Secret for KubeVela committing to Config Repo<a class="hash-link" href="#create-git-secret-for-kubevela-committing-to-config-repo" title="Direct link to heading">#</a></h2><p>After the new image is pushed to the image registry, KubeVela will be notified and update the <code>Application</code> file in the Git repository and cluster. Therefore, we need a secret with Git information for KubeVela to commit to the Git repository. Fill the following yaml files with your password and apply it to the cluster:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly yaml"><div tabindex="0" class="prism-code language-yaml codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token key atrule">apiVersion</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> v1</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token key atrule">kind</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> Secret</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token key atrule">metadata</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> my</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">secret</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token key atrule">type</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> kubernetes.io/basic</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">auth</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token key atrule">stringData</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">username</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> &lt;your username</span><span class="token punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">password</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> &lt;your password</span><span class="token punctuation" style="color:rgb(248, 248, 242)">&gt;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="setup-config-repository-1"></a>Setup Config Repository<a class="hash-link" href="#setup-config-repository-1" title="Direct link to heading">#</a></h2><p>The configuration repository is almost the same as the previous configuration, you only need to add the image registry config to the file. For more details, please refer to <a href="https://github.com/oam-dev/samples/tree/master/09.GitOps_Demo/for-developers/kubevela-config" target="_blank" rel="noopener noreferrer">Example Repository</a>.</p><p>Add the config of image registry in <code>clusters/apps.yaml</code>, it listens for image updates in the image registry:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly yaml"><div tabindex="0" class="prism-code language-yaml codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token punctuation" style="color:rgb(248, 248, 242)">...</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">imageRepository</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">image</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> &lt;your image</span><span class="token punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)"># if it&#x27;s a private image registry, use `kubectl create secret docker-registry` to create the secret</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)"># secretRef: imagesecret</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">filterTags</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token comment" style="color:rgb(98, 114, 164)"># filter the image tag</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">pattern</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;^master-[a-f0-9]+-(?P&lt;ts&gt;[0-9]+)&#x27;</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">extract</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;$ts&#x27;</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)"># use the policy to sort the latest image tag and update</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">policy</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">numerical</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token key atrule">order</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> asc</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)"># add more commit message</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">commitMessage</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;Image: {{range .Updated.Images}}{{println .}}{{end}}&quot;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>Modify the image field in <code>apps/my-app.yaml</code> and add annotation <code># {&quot;$imagepolicy&quot;: &quot;default:apps&quot;}</code>.
Notice that KubeVela will only be able to modify the image field if the annotation is added after the field. <code>default:apps</code> is <code>namespace:name</code> of the GitOps config file above.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly yaml"><div tabindex="0" class="prism-code language-yaml codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token key atrule">spec</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">components</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> my</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">server</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">type</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> webservice</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">properties</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token key atrule">image</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> ghcr.io/fogdong/test</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">fog</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain">master</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">cba5605f</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token number">1632714412</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)"># {&quot;$imagepolicy&quot;: &quot;default:apps&quot;}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>After update the files in <code>clusters/</code> to cluster, we can then update the application by modifying the code.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="modify-the-code"></a>Modify the code<a class="hash-link" href="#modify-the-code" title="Direct link to heading">#</a></h2><p>Change the <code>Version</code> to <code>0.1.6</code> and modify the data in database:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly go"><div tabindex="0" class="prism-code language-go codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">const</span><span class="token plain"> VERSION </span><span class="token operator">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;0.1.6&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token operator">...</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">func</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">InsertInitData</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">db </span><span class="token operator">*</span><span class="token plain">sql</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">DB</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    stmt</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> err </span><span class="token operator">:=</span><span class="token plain"> db</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">Prepare</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">insertInitData</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> err </span><span class="token operator">!=</span><span class="token plain"> </span><span class="token boolean">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token function" style="color:rgb(80, 250, 123)">panic</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">err</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">defer</span><span class="token plain"> stmt</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">Close</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token boolean">_</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> err </span><span class="token operator">=</span><span class="token plain"> stmt</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">Exec</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">&quot;KubeVela2&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;It&#x27;s another test user&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> err </span><span class="token operator">!=</span><span class="token plain"> </span><span class="token boolean">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token function" style="color:rgb(80, 250, 123)">panic</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">err</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>Commit the change to the Git Repository, we can see that our CI pipelines has built the image and push it to the image registry.</p><p>KubeVela will listen to the image registry and update the <code>apps/my-app.yaml</code> in Git Repository with the latest image tag.</p><p>We can see that there is a commit form <code>kubevelabot</code>, the commit message is always with a prefix <code>Update image automatically.</code> You can use format like <code>{{range .Updated.Images}}{{println .}}{{end}}</code> to specify the image name in the <code>commitMessage</code> field.</p><p><img alt="alt" src="/assets/images/gitops-commit-31c4a9477065754e172f97792bb14f91.png"></p><blockquote><p>Note that if you want to put the code and config in the same repository, you need to filter out the commit from KubeVela in CI configuration like below to avoid the repeat build of pipeline.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly shell"><div tabindex="0" class="prism-code language-shell codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token plain">jobs:</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain"> publish:</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">   if: </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;!contains(github.event.head_commit.message, &#x27;Update image automatically&#x27;)&quot;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div></blockquote><p>Re-check the <code>Application</code> in cluster, we can see that the image of the <code>my-app</code> has been updated after a while.</p><blockquote><p>KubeVela polls the latest information from the code and image repo periodically (at an interval that can be customized):</p><ul><li>When the <code>Application</code> file in the Git repository is updated, KubeVela will update the <code>Application</code> in the cluster based on the latest configuration.</li><li>When a new tag is added to the image registry, KubeVela will filter out the latest tag based on your policy and update it to Git repository. When the files in the repository are updated, KubeVela repeats the first step and updates the files in the cluster, thus achieving automatic deployment.</li></ul></blockquote><p>We can <code>curl</code> to <code>Ingress</code> to see the current version and data:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly shell"><div tabindex="0" class="prism-code language-shell codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token plain">$ kubectl get ingress</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">NAME        CLASS    HOSTS                 ADDRESS         PORTS   AGE</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">my-server   </span><span class="token operator">&lt;</span><span class="token plain">none</span><span class="token operator">&gt;</span><span class="token plain">   kubevela.example.com  </span><span class="token operator">&lt;</span><span class="token plain">ingress-ip</span><span class="token operator">&gt;</span><span class="token plain">    </span><span class="token number">80</span><span class="token plain">      162m</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">$ </span><span class="token function" style="color:rgb(80, 250, 123)">curl</span><span class="token plain"> -H </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;Host:kubevela.example.com&quot;</span><span class="token plain"> http://</span><span class="token operator">&lt;</span><span class="token plain">ingress-ip</span><span class="token operator">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">Version: </span><span class="token number">0.1</span><span class="token plain">.6</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">$ </span><span class="token function" style="color:rgb(80, 250, 123)">curl</span><span class="token plain"> -H </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;Host:kubevela.example.com&quot;</span><span class="token plain"> http://</span><span class="token operator">&lt;</span><span class="token plain">ingress-ip</span><span class="token operator">&gt;</span><span class="token plain">/db</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">User: KubeVela</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">Description: It</span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;s a test user</span></div><div class="token-line" style="color:#F8F8F2"><span class="token string" style="display:inline-block;color:rgb(255, 121, 198)">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">User: KubeVela2</span></div><div class="token-line" style="color:#F8F8F2"><span class="token string" style="color:rgb(255, 121, 198)">Description: It&#x27;</span><span class="token plain">s another </span><span class="token builtin class-name" style="color:rgb(189, 147, 249)">test</span><span class="token plain"> user</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>The <code>Version</code> has been updated successfully! Now we&#x27;re done with everything from changing the code to automatically applying to the cluster.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="summary"></a>Summary<a class="hash-link" href="#summary" title="Direct link to heading">#</a></h2><p>For platform admins/SREs, they update the config repo to operate the application and infrastructure. KubeVela will synchronize the config to the cluster, simplifying the deployment process.</p><p>For end users/developers, they write the source code, push it to Git, and then re-deployment will happen. It will make CI to build the image. KubeVela will then update the image field and apply the deployment config.</p><p>By integrating with GitOps, KubeVela helps users speed up deployment and simplify continuous deployment.</p></div><footer class="row margin-vert--lg"><div class="col"><strong>Tags:</strong><a class="margin-horiz--sm" href="/blog/tags/kube-vela">KubeVela</a></div></footer></article><article class="margin-bottom--xl"><header><h2 class="margin-bottom--sm blogPostTitle_GeHD"><a href="/blog/2021/10/08/blog-1.1">KubeVela Releases 1.1, Reaching New Peaks in Cloud-Native Continuous Delivery</a></h2><div class="margin-vert--md"><time datetime="2021-10-08T00:00:00.000Z" class="blogPostDate_fNvV">October 8, 2021 Â· 7 min read</time></div><div class="avatar margin-vert--md"><a href="https://github.com/oam-dev/kubevela" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img src="https://kubevela.io/img/logo.svg" alt="KubeVela Maintainers"></a><div class="avatar__intro"><h4 class="avatar__name"><a href="https://github.com/oam-dev/kubevela" target="_blank" rel="noopener noreferrer">KubeVela Maintainers</a></h4><small class="avatar__subtitle">KubeVela Team</small></div></div></header><div class="markdown"><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="overview"></a>Overview<a class="hash-link" href="#overview" title="Direct link to heading">#</a></h2><p>Initialized by Alibaba and currently a CNCF sandbox project, KubeVela is a modern application platform that focues on modeling the delivery workflow of micro-services on top of Kubernetes, Terraform, Flux Helm controller and beyond. This brings strong value added to the existing GitOps and IaC primitives with battle tested application delivery practices including deployment pipeline, across-environment promotion, manual approval, canary rollout and notification, etc.</p><p>This is the first open source project in CNCF that focuses on the full lifecycle continuous delivery experience from abstraction, rendering, orchestration to deployment. This reminds us of Spinnaker, but designed to be simpler, cloud native, can be used with any CI pipeline and easily extended.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="introduction"></a>Introduction<a class="hash-link" href="#introduction" title="Direct link to heading">#</a></h2><p>Kubernetes has made it easy to build application deployment infrastructure, either on cloud, on-prem, or on IoT environments. But there are still two problems for developers to manage micro-service applications. First, developers just want to deploy, but delivering application with lower level infrastructure/orchestrator primitives is too much for them. It&#x27;s very hard for developers to keep up with all these details and they need a simpler abstraction to &quot;just deploy&quot;. Second, application delivery workflow is a basic need for &quot;just deploy&quot;, but it is inherently out of scope of Kubernetes itself. The existing workflow addons/projects are too generic, they are way more than focusing on delivering applications only. These problems makes continuous delivery complex and unscalable even with the help of Kubernetes. GitOps can help in deploying phase, but lack the capabilities of abstracting, rendering, and orchestration. This results in low SDO (software delivery and operation) performance and burnout of DevOps engineers. In worst case, it could cause production outage if users make unsafe operations due to the complexity.</p><p>The latest DORA survey [1] shows that organizations adopting continuous delivery are more likely to have processes that are more high quality, low-risk, and cost-effective. Though the question is how we can make it more focused and easy to practice. Hence, KubeVela introduces Open Application Model (OAM), a higher level abstraction for modeling application delivery workflow with app-centric, consistent and declarative approach. This empowers developers to continuously verify and deploy their applications with confidence, standing on the shoulders of Kubernetes control theory, GitOps, IaC and beyond.</p><p><img src="https://static.kubevela.net/images/cicd.png"> </p><p>KubeVela latest 1.1 release is a major milestone bringing more continuous delivery features. It highlights:</p><ul><li><strong>Multi-environment, multi-cluster rollout</strong>: KubeVela allows users to define the environments and the clusters which application components to deploy to or to promote. This makes it easier for users to manage multi-stage application rollout. For example, users can deploy applicatons to test environment and then promote to production environment.</li><li><strong>Canary rollout and approval gate</strong>: Application delivery is a procedural workflow that takes multiple steps. KubeVela provides such workflow on top of Kubernetes. By default, Users can use KubeVela to build canary rollout, approval gate, notification pipelines to deliver applications confidently. Moreover, the workflow model is declarative and extensible. Workflow steps can be stored in Git to simplify management.</li><li><strong>Addon management</strong>: All KubeVela capabilities (e.g. Helm chart deployment) are pluggable. They are managed as addons [2]. KubeVela provides simple experience via CLI/UI to discover, install, uninstall addons. There is an official addon registry. Users can also bring their own addon registries.</li><li><strong>Cloud Resource</strong>: Users can enable Terraform addon on KubeVela to deploy cloud resources using the same abstraction to deploy applications. This enables cooperative delivery of application and its dependencies. That includes databases, redis, message queues, etc. By using KubeVela, users don&#x27;t need to switch over to another interface to manage middlewares. This provides unified experience and aligns better with the upcoming trends in CNCF Cooperative-Delivery Working Group [3].</li></ul><p>That is the introduction about KubeVela 1.1 release. In the following, we will provide deep-dive and examples for the new features.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="multi-environment-multi-cluster-rollout"></a>Multi-Environment, Multi-Cluster Rollout<a class="hash-link" href="#multi-environment-multi-cluster-rollout" title="Direct link to heading">#</a></h2><p>Users would need to deploy applications across clusters in different regions. Additionally, users would have test environment to run some automated tests first before deploying to production environment. However, it remains mysterious for many users how to do multi-environment, multi-cluster application rollout on Kubernetes. </p><p>KubeVela 1.1 introduces multi-environment, multi-cluster rollout. It integrates Open Cluster Management and Karmada projects to handle multi-cluster management. Based on that, it provides EnvBinding Policy to define per-environment config patch and placement decisions. Here is an example of EnvBinding policy:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly yaml"><div tabindex="0" class="prism-code language-yaml codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">policies</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> example</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">multi</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">env</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">policy</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">type</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> env</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">binding</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">properties</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token key atrule">envs</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> staging</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token key atrule">placement</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)"># selecting the cluster to deploy to</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">              </span><span class="token key atrule">clusterSelector</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> cluster</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">staging</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token key atrule">selector</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)"># selecting which component to use</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">              </span><span class="token key atrule">components</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> hello</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">world</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">server</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> prod</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token key atrule">placement</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">              </span><span class="token key atrule">clusterSelector</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> cluster</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">prod</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token key atrule">patch</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)"># overlay patch on above components</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">              </span><span class="token key atrule">components</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> hello</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">world</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">server</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                  </span><span class="token key atrule">type</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> webservice</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                  </span><span class="token key atrule">traits</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">type</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> scaler</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                      </span><span class="token key atrule">properties</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                        </span><span class="token key atrule">replicas</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token number">3</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>Below is a demo for a multi-stage application rollout from Staging to Production. The local cluster serves as the control plane and the rest two are the runtime clusters.</p><p><img src="https://static.kubevela.net/images/deploy_cloud.gif"></p><p>Note that all the resources and statuses are aggregated and abstracted in the KubeVela Applications. Did any problems happen, it will pinpoint the problematic resources for users. This results in faster recovery time and more manageable delivery.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="canary-rollout-approval-notification"></a>Canary Rollout, Approval, Notification<a class="hash-link" href="#canary-rollout-approval-notification" title="Direct link to heading">#</a></h3><p>Can you build a canary rollout pipeline in 5 minutes? Ask Kubernetes users and they would tell you it is not even enough to learn an Istio concept. We belive that as a developer you do not need to master Istio to build a canary rollout pipeline. KubeVela abstracts away the low level details and provides a simple solution as follows.</p><p>First, installing Istio is made easy via KubeVela addons:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly bash"><div tabindex="0" class="prism-code language-bash codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token plain">vela addon </span><span class="token builtin class-name" style="color:rgb(189, 147, 249)">enable</span><span class="token plain"> istio</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>Then, users just need to define how many batches for the rollout:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly yaml"><div tabindex="0" class="prism-code language-yaml codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token key atrule">traits</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">type</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> rollout</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">properties</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">targetSize</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token number">100</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">rolloutBatches</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">replicas</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token number">10</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">replicas</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token number">90</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>Finally, define the workflow of canary, approval, and notification:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly yaml"><div tabindex="0" class="prism-code language-yaml codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">workflow</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">steps</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> rollout</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">1st</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">batch</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token key atrule">type</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> canary</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">rollout</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token key atrule">properties</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token comment" style="color:rgb(98, 114, 164)"># just upgrade first batch of component</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token key atrule">batchPartition</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token number">0</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token key atrule">traffic</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token key atrule">weightedTargets</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">              </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">revision</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> reviews</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">v1</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                </span><span class="token key atrule">weight</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token number">90</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)"># 90% to the old version</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">              </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">revision</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> reviews</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">v2</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                </span><span class="token key atrule">weight</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token number">10</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)"># 10% to the new version</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> approval</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">gate</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token key atrule">type</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> suspend</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> rollout</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">rest</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token key atrule">type</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> canary</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">rollout</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token key atrule">properties</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token key atrule">batchPartition</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token number">1</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token key atrule">traffic</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token key atrule">weightedTargets</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">              </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">revision</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> reviews</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">v2</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                </span><span class="token key atrule">weight</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token number">100</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)"># 100% shift to new version</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                </span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> send</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">msg</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token key atrule">type</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> webhook</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">notification</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token key atrule">properties</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token key atrule">slack</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token key atrule">url</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> &lt;your slack webhook url</span><span class="token punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token key atrule">text</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;rollout finished&quot;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>Here is a full demo:</p><p><img src="https://static.kubevela.net/images/rollout.gif"></p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="what-comes-next"></a>What Comes Next<a class="hash-link" href="#what-comes-next" title="Direct link to heading">#</a></h2><p>In this KubeVela release we have built the cornerstone for continuous delivery on Kubernetes. For the upcoming release our major theme will be improving user experience. We will release a dashboard that takes the user experience to another level. Besides that, we will keep improving our CLI tools, debuggability, observability. This will ensure our users can self serve to not only deploy and manage applications, but also debug and analyze the delivery pipelines.</p><p>For more project roadmap information, please see Kubevela <a href="https://kubevela.io/docs/roadmap/2021-12-roadmap" target="_blank" rel="noopener noreferrer">RoadMap</a>.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="join-the-community"></a>Join the Community<a class="hash-link" href="#join-the-community" title="Direct link to heading">#</a></h2><p>KubeVela is a community-driven, open-source project. Dozens of leading enterprises have adopted KubeVela in production, including Alibaba, Tencent, ByteDance, XPeng Motors. You are welcome to join the community. Here are next steps:</p><ul><li>Read documentation and try it out: <a href="https://kubevela.io" target="_blank" rel="noopener noreferrer">kubevela.io</a>â€‹</li><li>Join Slack channel to address your questions: <a href="https://cncf.slack.com/messages/kubevela/" target="_blank" rel="noopener noreferrer">CNCF #kubevela</a></li><li>Welcome to Star/Watch/Fork the project and contribute: <a href="https://github.com/oam-dev/kubevela" target="_blank" rel="noopener noreferrer">github.com/oam-dev/kubevela</a>â€‹</li><li>If you&#x27;re already a user, please register in <a href="https://github.com/oam-dev/kubevela/issues/1662" target="_blank" rel="noopener noreferrer">this issue</a> and motivate the community!</li></ul><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="references"></a>References<a class="hash-link" href="#references" title="Direct link to heading">#</a></h2><p>(1) DORA full report: <a href="https://cloud.google.com/blog/products/devops-sre/announcing-dora-2021-accelerate-state-of-devops-report" target="_blank" rel="noopener noreferrer">https://cloud.google.com/blog/products/devops-sre/announcing-dora-2021-accelerate-state-of-devops-report</a>
(2) KubeVela Addon: <a href="https://github.com/oam-dev/catalog/tree/master/addons/example" target="_blank" rel="noopener noreferrer">https://github.com/oam-dev/catalog/tree/master/addons/example</a>
(3) Cooperative Delivery Charter: <a href="https://github.com/cncf/tag-app-delivery/blob/master/cooperative-delivery-wg/charter.md" target="_blank" rel="noopener noreferrer">https://github.com/cncf/tag-app-delivery/blob/master/cooperative-delivery-wg/charter.md</a></p></div><footer class="row margin-vert--lg"><div class="col"><strong>Tags:</strong><a class="margin-horiz--sm" href="/blog/tags/dev-ops">DevOps</a></div></footer></article><article class="margin-bottom--xl"><header><h2 class="margin-bottom--sm blogPostTitle_GeHD"><a href="/blog/2021/09/02/kubevela-jenkins-cicd">Using Jenkins + KubeVela for Application Continuous Delivery</a></h2><div class="margin-vert--md"><time datetime="2021-09-02T00:00:00.000Z" class="blogPostDate_fNvV">September 2, 2021 Â· 12 min read</time></div><div class="avatar margin-vert--md"><a href="https://github.com/oam-dev/kubevela" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img src="https://kubevela.io/img/logo.svg" alt="Da Yin, Yang Song"></a><div class="avatar__intro"><h4 class="avatar__name"><a href="https://github.com/oam-dev/kubevela" target="_blank" rel="noopener noreferrer">Da Yin, Yang Song</a></h4><small class="avatar__subtitle">KubeVela Team</small></div></div></header><div class="markdown"><p>KubeVela bridges the gap between applications and infrastructures, enabling easy delivery and management of development codes. Compared to Kubernetes objects, the Application in KubeVela better abstracts and simplifies the configurations which developers care about, and leave complex infrastruature capabilities and orchestration details to platform engineers. The KubeVela apiserver further exposes HTTP interfaces, which help developers to deploy applications even without Kubernetes cluster access.</p><p>This article will use Jenkins, a popular continuous integration tool, as basis and give a brief introduction to how to build GitOps-based application continuous delivery highway.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="continuous-delivery-highway"></a>Continuous Delivery Highway<a class="hash-link" href="#continuous-delivery-highway" title="Direct link to heading">#</a></h2><p>As application developer, you might care more about whether your application is functioning correctly and if development is convenient. There will be several system components on this highway to help you achieve that.</p><ol><li>First, you need a git repo to place program codes, test codes and a YAML file to declare your KubeVela application.</li><li>Second, you also need a continuous integration tool to help you automate the integration test of codes, build container images and push images to image repo.</li><li>Finally, you need to have a Kubernetes cluster and install KubeVela in it, with its apiserver function enabled.</li></ol><blockquote><p>Currently, the access management for KubeVela apiserver is under construction. You will need to configure apiserver access in later version of KubeVela (after v1.1).</p></blockquote><p>In this article, we adopt GitHub as the git repo, Jenkins as the CI tool, DockerHub as the image repo. We use a simple HTTP Server written in Golang as example. The whole process of continuous delivery is shown as below. We can see that on this highway of continuous delivery, developers only need to care about application development and managing code version with Git. The highway will help developer run integration test and deploy applications into target Kubernetes cluster automatically.</p><p><img alt="arch" src="/assets/images/arch-53b2b1a473f0d637d4c7c0b9a81dd2b0.png"></p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="set-up-environment"></a>Set-up Environment<a class="hash-link" href="#set-up-environment" title="Direct link to heading">#</a></h2><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="jenkins"></a>Jenkins<a class="hash-link" href="#jenkins" title="Direct link to heading">#</a></h3><blockquote><p>This article takes Jenkins as the CI tool. Developers can choose other CI tools like Travis or GitHub Action.</p></blockquote><p>First you need to set up Jenkins to deploy CI pipelines. The installation and initialization of Jenkins could refer to the <a href="https://www.jenkins.io/doc/book/installing/linux/" target="_blank" rel="noopener noreferrer">official docs</a>.</p><p>Notice that since the CI pipeline in this example is based on Docker and GitHub, you need to install related plugins in Jenkins (<em>Dashboard &gt; Manage Jenkins &gt; Manage Plugins</em>), including Pipelineã€HTTP Request Pluginã€Docker Pipelineã€Docker Plugin.</p><p>Besides, you also need to configure Docker environment for Jenkins to use (<em>Dashboard &gt; Manage Jenkins &gt; Configure System &gt; Docker Builder</em>). If Docker has already been installed, you can set Docker URL as <code>unix:///var/run/docker.sock</code>.</p><p>Since the docker image will be pushed to image repo during the running of CI pipelines, you also need to store image repo accounts in Jenkins Credintial (<em>Dashboard &gt; Manage Jenkins &gt; Manage Credentials &gt; Add Credentials</em>), such as DockerHub username and password.</p><p><img alt="jenkins-credential" src="/assets/images/jenkins-credential-52c71b3f3a886ec0596a29a2356ad291.png"></p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="github"></a>GitHub<a class="hash-link" href="#github" title="Direct link to heading">#</a></h3><blockquote><p>This example uses GitHub as git repo. Developer can change it to other repos on demand, such as Gitlab.</p></blockquote><p>To enable Jenkins to retrieve GitHub updates and write pipeline status back to GitHub, you need to execute the following two steps in GitHub. </p><ol><li><a href="https://github.com/settings/tokens/new" target="_blank" rel="noopener noreferrer">Configure</a> Personal Access Token. Notice to check <code>repo:status</code> to get the permission for writing commit status.</li></ol><p><img alt="github-pat" src="/assets/images/github-pat-a8de5950eaf01a6d416a869d70b189ac.png"></p><p>Then fill Personal Access Token from GitHub in Jenkins Credential (with Secret Text type).</p><p><img alt="jenkins-secret-text" src="/assets/images/jenkins-secret-text-0de6c324500b26a5bfb81520ff7eab2b.png"></p><p>Finally, go to <em>Dashboard &gt; Manage Jenkins &gt; Configure System &gt; GitHub</em> in Jenkins and click Add <em>GitHub Server</em> to fill the newly created credential in. You can click <em>Test connection</em> to check if the configuration is correct.</p><p><img alt="jenkins-github" src="/assets/images/jenkins-github-e99c47fab606f6c9c9f3f6f841840329.png"></p><ol start="2"><li>Add Webhook to GitHub code repo settings. Fill Jenkins Webhook address into it. For example, <a href="http://my-jenkins.example.com/github-webhook/" target="_blank" rel="noopener noreferrer">http://my-jenkins.example.com/github-webhook/</a> . In this way, all Push events in this code repo will be pushed to Jenkins.</li></ol><p><img alt="github-webhook" src="/assets/images/github-webhook-5579402b6bc37238d42842fd5d52fd02.png"></p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="kubevela"></a>KubeVela<a class="hash-link" href="#kubevela" title="Direct link to heading">#</a></h3><p>You need to install KubeVela in your Kubernetes cluster and enable the apiserver function. Refer to <a href="/docs/platform-engineers/advanced-install#install-kubevela-with-apiserver">official doc</a> for details.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="composing-applications"></a>Composing Applications<a class="hash-link" href="#composing-applications" title="Direct link to heading">#</a></h2><p>We use a simple HTTP Server as example. Here, we declare a constant named <code>VERSION</code> and print it when accessing the HTTP service. A simple test is also set up, which can be used to validate the format of <code>VERSION</code>.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly go"><div tabindex="0" class="prism-code language-go codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">// main.go</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">package</span><span class="token plain"> main</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">import</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;fmt&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;net/http&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">const</span><span class="token plain"> VERSION </span><span class="token operator">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;0.1.0-v1alpha1&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">func</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">main</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    http</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">HandleFunc</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">&quot;/&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">func</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">w http</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">ResponseWriter</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> r </span><span class="token operator">*</span><span class="token plain">http</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Request</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token boolean">_</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token boolean">_</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> fmt</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">Fprintf</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">w</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;Version: %s\n&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> VERSION</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> err </span><span class="token operator">:=</span><span class="token plain"> http</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">ListenAndServe</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">&quot;:8088&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token boolean">nil</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"> err </span><span class="token operator">!=</span><span class="token plain"> </span><span class="token boolean">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token function" style="color:rgb(80, 250, 123)">println</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">err</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">Error</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly go"><div tabindex="0" class="prism-code language-go codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">// main_test.go</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">package</span><span class="token plain"> main</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">import</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;regexp&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;testing&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">const</span><span class="token plain"> verRegex </span><span class="token builtin" style="color:rgb(189, 147, 249)">string</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">`^v?([0-9]+)(\.[0-9]+)?(\.[0-9]+)?`</span><span class="token plain"> </span><span class="token operator">+</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token string" style="color:rgb(255, 121, 198)">`(-([0-9A-Za-z\-]+(\.[0-9A-Za-z\-]+)*))?`</span><span class="token plain"> </span><span class="token operator">+</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token string" style="color:rgb(255, 121, 198)">`(\+([0-9A-Za-z\-]+(\.[0-9A-Za-z\-]+)*))?$`</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">func</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">TestVersion</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">t </span><span class="token operator">*</span><span class="token plain">testing</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">T</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> ok</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token boolean">_</span><span class="token plain"> </span><span class="token operator">:=</span><span class="token plain"> regexp</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">MatchString</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">verRegex</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> VERSION</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"> </span><span class="token operator">!</span><span class="token plain">ok </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        t</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">Fatalf</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">&quot;invalid version: %s&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> VERSION</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>To build container image for the HTTP server and publishing it as KubeVela Application into Kubernetes, we also need another two files <code>Dockerfile</code> and <code>app.yaml</code> in the code repo. They are used to describe how container image is built and configure the KubeVela Application respectively.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly Dockerfile"><div tabindex="0" class="prism-code language-Dockerfile codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token plain"># Dockerfile</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">FROM golang:1.13-rc-alpine3.10 as builder</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">WORKDIR /app</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">COPY main.go .</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">RUN go build -o kubevela-demo-cicd-app main.go</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">FROM alpine:3.10</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">WORKDIR /app</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">COPY --from=builder /app/kubevela-demo-cicd-app /app/kubevela-demo-cicd-app</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">ENTRYPOINT ./kubevela-demo-cicd-app</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">EXPOSE 8088</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>In <code>app.yaml</code>, we declare the application should contain 5 replica and expose the service through <code>Ingress</code>. The <code>labels</code> trait is used to tag Application Pods with current git commit id. Then the delivery pipeline in Jenkins will inject GIT_COMMIT into it and submit the Application configuration to KubeVela apiserver. Then the updates for Application will be triggered. The application will update 2 replica first, then hang and wait for manual approve. After developer confirms the change is valid, the rest 3 replica will be updated. This canary release is configured by the <code>rollout</code> trait declared in the Application.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly yaml"><div tabindex="0" class="prism-code language-yaml codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)"># app.yaml</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token key atrule">apiVersion</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> core.oam.dev/v1beta1</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token key atrule">kind</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> Application</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token key atrule">metadata</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> kubevela</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">demo</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">app</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token key atrule">spec</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">components</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> kubevela</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">demo</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">app</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">web</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">type</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> webservice</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">properties</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token key atrule">image</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> somefive/kubevela</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">demo</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">cicd</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">app</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token key atrule">imagePullPolicy</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> Always</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token key atrule">port</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token number">8080</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">traits</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">type</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> rollout</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token key atrule">properties</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token key atrule">rolloutBatches</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">              </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">replicas</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token number">2</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">              </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">replicas</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token number">3</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token key atrule">batchPartition</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token number">0</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token key atrule">targetSize</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token number">5</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">type</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> labels</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token key atrule">properties</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token key atrule">jenkins-build-commit</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> GIT_COMMIT</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">type</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> ingress</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token key atrule">properties</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token key atrule">domain</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> kubevela</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">demo</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">cicd</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">app.cf7c0ed25b151437ebe1ef58efc29bca4.us</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">west</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">1.alicontainer.com</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token key atrule">http</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">              </span><span class="token key atrule">&quot;/&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token number">8088</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="configure-ci-pipelines"></a>Configure CI pipelines<a class="hash-link" href="#configure-ci-pipelines" title="Direct link to heading">#</a></h2><p>In this article, we set up two pipelines in Jenkins. One is the test pipeline, which is for running tests for application codes. The other one is the delivery pipeline, which builds container images and uploads them to image repo. Then the application configuration will be updated.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="test-pipeline"></a>Test Pipeline<a class="hash-link" href="#test-pipeline" title="Direct link to heading">#</a></h3><p>Create a new pipeline in Jenkins. Set <em>Build Triggers</em> as <em>GitHub hook trigger for GITScm polling</em>.</p><p><img alt="test-pipeline-create" src="/assets/images/test-pipeline-create-34edf7a7b95307cec884803ca545c2e3.png">
<img alt="test-pipeline-config" src="/assets/images/test-pipeline-config-3ae2830ca7d45dbe9579a7814d96abc0.png"></p><p>This pipeline uses golang image as execution environment at first. Next, it checkouts the <code>dev</code> branch of the target GitHub repo, indicating that this pipeline will be triggered by push events to <code>dev</code> branch. The piepline status will be written back to GitHub after execution finished.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly groovy"><div tabindex="0" class="prism-code language-groovy codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token plain">void setBuildStatus(String message, String state) {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  step([</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      $class: &quot;GitHubCommitStatusSetter&quot;,</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      reposSource: [$class: &quot;ManuallyEnteredRepositorySource&quot;, url: &quot;https://github.com/Somefive/KubeVela-demo-CICD-app&quot;],</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      contextSource: [$class: &quot;ManuallyEnteredCommitContextSource&quot;, context: &quot;ci/jenkins/test-status&quot;],</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      errorHandlers: [[$class: &quot;ChangingBuildStatusErrorHandler&quot;, result: &quot;UNSTABLE&quot;]],</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      statusResultSource: [ $class: &quot;ConditionalStatusResultSource&quot;, results: [[$class: &quot;AnyBuildResult&quot;, message: message, state: state]] ]</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  ]);</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">}</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">pipeline {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    agent {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        docker { image &#x27;golang:1.13-rc-alpine3.10&#x27; }</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    stages {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        stage(&#x27;Prepare&#x27;) {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            steps {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                script {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                    def checkout = git branch: &#x27;dev&#x27;, url: &#x27;https://github.com/Somefive/KubeVela-demo-CICD-app.git&#x27;</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                    env.GIT_COMMIT = checkout.GIT_COMMIT</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                    env.GIT_BRANCH = checkout.GIT_BRANCH</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                    echo &quot;env.GIT_BRANCH=${env.GIT_BRANCH},env.GIT_COMMIT=${env.GIT_COMMIT}&quot;</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                }</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                setBuildStatus(&quot;Test running&quot;, &quot;PENDING&quot;);</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            }</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        }</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        stage(&#x27;Test&#x27;) {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            steps {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                sh &#x27;CGO_ENABLED=0 GOCACHE=$(pwd)/.cache go test *.go&#x27;</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            }</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        }</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    post {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        success {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            setBuildStatus(&quot;Test success&quot;, &quot;SUCCESS&quot;);</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        }</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        failure {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            setBuildStatus(&quot;Test failed&quot;, &quot;FAILURE&quot;);</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        }</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="delivery-pipeline"></a>Delivery Pipeline<a class="hash-link" href="#delivery-pipeline" title="Direct link to heading">#</a></h3><p>The delivery pipeline, similar to the test pipeline, first pulls codes in <code>prod</code> branch of the git repo. Then use Docker to build images and push it to remote image repo. (Here we use DockerHub, the <em>withRegistry</em> function takes image repo location and the Credential ID of the repo as parameters). After image been built, the pipeline converts Application YAML file into JSON file, with GIT_COMMIT injected. Finally, the pipeline sends POST requests to KubeVela apiserver (here is <a href="http://47.88.24.19/" target="_blank" rel="noopener noreferrer">http://47.88.24.19/</a>) for creating or updating target application.</p><blockquote><p>Currently, KubeVela apiserver takes JSON object as inputs. Therefore we do extra conversion in the delivery pipeline. In the future, the KubeVela apiserver will further improve and simplify this interaction process. The admission management will be added as well to address the security issue.</p></blockquote><blockquote><p>In this case we will create an application named <em>cicd-demo-app</em> in Namespace <em>kubevela-demo-namespace</em>. Notice that the Namespace need to be created in Kubernetes in advance. KubeVela apiserver will simplify it in later version.</p></blockquote><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly groovy"><div tabindex="0" class="prism-code language-groovy codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token plain">void setBuildStatus(String message, String state) {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  step([</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      $class: &quot;GitHubCommitStatusSetter&quot;,</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      reposSource: [$class: &quot;ManuallyEnteredRepositorySource&quot;, url: &quot;https://github.com/Somefive/KubeVela-demo-CICD-app&quot;],</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      contextSource: [$class: &quot;ManuallyEnteredCommitContextSource&quot;, context: &quot;ci/jenkins/deploy-status&quot;],</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      errorHandlers: [[$class: &quot;ChangingBuildStatusErrorHandler&quot;, result: &quot;UNSTABLE&quot;]],</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      statusResultSource: [ $class: &quot;ConditionalStatusResultSource&quot;, results: [[$class: &quot;AnyBuildResult&quot;, message: message, state: state]] ]</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  ]);</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">}</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">pipeline {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    agent any</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    stages {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        stage(&#x27;Prepare&#x27;) {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            steps {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                script {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                    def checkout = git branch: &#x27;prod&#x27;, url: &#x27;https://github.com/Somefive/KubeVela-demo-CICD-app.git&#x27;</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                    env.GIT_COMMIT = checkout.GIT_COMMIT</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                    env.GIT_BRANCH = checkout.GIT_BRANCH</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                    echo &quot;env.GIT_BRANCH=${env.GIT_BRANCH},env.GIT_COMMIT=${env.GIT_COMMIT}&quot;</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                    setBuildStatus(&quot;Deploy running&quot;, &quot;PENDING&quot;);</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                }</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            }</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        }</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        stage(&#x27;Build&#x27;) {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            steps {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                script {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                    docker.withRegistry(&quot;https://registry.hub.docker.com&quot;, &quot;DockerHubCredential&quot;) {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                        def customImage = docker.build(&quot;somefive/kubevela-demo-cicd-app&quot;)</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                        customImage.push()</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                    }</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                }</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            }</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        }</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        stage(&#x27;Deploy&#x27;) {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            steps {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                sh &#x27;wget -q &quot;https://github.com/mikefarah/yq/releases/download/v4.12.1/yq_linux_amd64&quot;&#x27;</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                sh &#x27;chmod +x yq_linux_amd64&#x27;</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                script {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                    def app = sh (</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                        script: &quot;./yq_linux_amd64 eval -o=json &#x27;.spec&#x27; app.yaml | sed -e &#x27;s/GIT_COMMIT/$GIT_COMMIT/g&#x27;&quot;,</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                        returnStdout: true</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                    )</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                    echo &quot;app: ${app}&quot;</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                    def response = httpRequest acceptType: &#x27;APPLICATION_JSON&#x27;, contentType: &#x27;APPLICATION_JSON&#x27;, httpMode: &#x27;POST&#x27;, requestBody: app, url: &quot;http://47.88.24.19/v1/namespaces/kubevela-demo-namespace/applications/cicd-demo-app&quot;</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                    println(&#x27;Status: &#x27;+response.status)</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                    println(&#x27;Response: &#x27;+response.content)</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                }</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            }</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        }</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    post {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        success {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            setBuildStatus(&quot;Deploy success&quot;, &quot;SUCCESS&quot;);</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        }</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        failure {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            setBuildStatus(&quot;Deploy failed&quot;, &quot;FAILURE&quot;);</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        }</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><blockquote><p>NOTE: the deploy stage is written with KubeVela v1.1. The apiserver interaction method is updated in KubeVela v1.2, leveraging VelaUX (the UI dashboard) and webhook trigger. If you are using KubeVela v1.2.0+, you should refer to the latest documents.</p></blockquote><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="performance"></a>Performance<a class="hash-link" href="#performance" title="Direct link to heading">#</a></h2><p>After finishing the configuration process described above, the whole process of continuous delivery has already been set up. Let&#x27;s check how it works.</p><p><img alt="pipeline-overview" src="/assets/images/pipeline-overview-36827d3925d667b9d14612cb59e8fb4e.png"></p><p>First, we set the <code>VERSION</code> constant in <code>main.go</code> to <code>Bad Version Number</code>, aka,</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly go"><div tabindex="0" class="prism-code language-go codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">const</span><span class="token plain"> VERSION </span><span class="token operator">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;Bad Version Number&quot;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>Then, we submit this change to <code>dev</code> branch. We can see that the test pipeline in Jenkins is triggered and the failure status is written back to GitHub.</p><p><img alt="test-pipeline-fail" src="/assets/images/test-pipeline-fail-23682b9d0c60a43f26be0a5a98e8a413.png">
<img alt="test-github-fail" src="/assets/images/test-github-fail-5dd21696c58a212cf6ca2ee80e56567e.png"></p><p>We edit the <code>VERSION</code> to <code>0.1.1</code> again and resubmit it. Now we see that the test pipeline is successfully executed, with the commit in GitHub marked as succeeded.</p><p><img alt="test-pipeline-success" src="/assets/images/test-pipeline-success-cd84def7976efb35b5071c9e361d2a77.png">
<img alt="test-github-success" src="/assets/images/test-github-success-1d9c59d67bfd9b24d8b455fa21c6d985.png"></p><p>Then we issue a Pull Request to merge <code>dev</code> branch into <code>prod</code> branch.</p><p><img alt="pull-request" src="/assets/images/pull-request-eca7ff259bb26a6661d79691728b0b31.png"></p><p>The Jenkins delivery pipeline is triggered once the Pull Request is accepted. After execution finished, the latest commit in prod branch is also marked as succeeded.</p><p><img alt="deploy-pipeline-success" src="/assets/images/deploy-pipeline-success-7890c92b41e666ef46f3bd2dc1975ee7.png">
<img alt="deploy-github-success" src="/assets/images/deploy-github-success-07f305b1b587e3fa8acc5df68fd8c297.png"></p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly bash"><div tabindex="0" class="prism-code language-bash codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token plain">$ kubectl get app -n kubevela-demo-namespace</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">NAME                     COMPONENT               TYPE         PHASE     HEALTHY   STATUS   AGE</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">kubevela-demo-cicd-app   kubevela-demo-app-web   webservice   running   </span><span class="token boolean">true</span><span class="token plain">               112s</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">$ kubectl get deployment -n kubevela-demo-namespace</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">NAME                       READY   UP-TO-DATE   AVAILABLE   AGE</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">kubevela-demo-app-web-v1   </span><span class="token number">2</span><span class="token plain">/2     </span><span class="token number">2</span><span class="token plain">            </span><span class="token number">2</span><span class="token plain">           2m1s</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>As shown above, the target application is successfully accepted by KubeVela apiserver and related resources are created by KubeVela controller. The current replica number of Deployment is 2. After deleting <code>batchPartition : 0</code> in the <code>rollout</code> trait of the application, which means confirming current release, the Deployment replica is updated to 5. Now we can access the domain configured in Ingress and get the current version number.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly bash"><div tabindex="0" class="prism-code language-bash codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token plain">$ kubectl edit app -n kubevela-demo-namespace</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">application.core.oam.dev/kubevela-demo-cicd-app edited</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">$ kubectl get deployment -n kubevela-demo-namespace -w</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">NAME                       READY   UP-TO-DATE   AVAILABLE   AGE</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">kubevela-demo-app-web-v1   </span><span class="token number">4</span><span class="token plain">/5     </span><span class="token number">5</span><span class="token plain">            </span><span class="token number">4</span><span class="token plain">           3m39s</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">kubevela-demo-app-web-v1   </span><span class="token number">5</span><span class="token plain">/5     </span><span class="token number">5</span><span class="token plain">            </span><span class="token number">5</span><span class="token plain">           3m39s</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">kubevela-demo-app-web-v1   </span><span class="token number">5</span><span class="token plain">/5     </span><span class="token number">5</span><span class="token plain">            </span><span class="token number">5</span><span class="token plain">           3m40s</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">kubevela-demo-app-web-v1   </span><span class="token number">5</span><span class="token plain">/5     </span><span class="token number">5</span><span class="token plain">            </span><span class="token number">5</span><span class="token plain">           3m40s</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">$ </span><span class="token function" style="color:rgb(80, 250, 123)">curl</span><span class="token plain"> http://kubevela-demo-cicd-app.cf7c0ed25b151437ebe1ef58efc29bca4.us-west-1.alicontainer.com/</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">Version: </span><span class="token number">0.1</span><span class="token plain">.1</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>Repeat the steps above. Upgrade the version number to <code>0.1.2</code>. Finish both test pipeline and delivery pipeline. Then we will see there is a version change to the Deployment managed by the target application. The replica number of the old Deployment decreases from 5 to 3 while the new one contains 2 replica at this moment. If we access the service now, we will find sometimes the old version number is returned and sometimes the new version number is displayed. This is because when rolling update the application, both new version replica and old version replica exist. The incoming traffic will be dispatched to different version replica. Therefore we can observe two different version at the same time. </p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly bash"><div tabindex="0" class="prism-code language-bash codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token plain">$ kubectl get deployment -n kubevela-demo-namespace -w</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">NAME                       READY   UP-TO-DATE   AVAILABLE   AGE</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">kubevela-demo-app-web-v1   </span><span class="token number">5</span><span class="token plain">/5     </span><span class="token number">5</span><span class="token plain">            </span><span class="token number">5</span><span class="token plain">           11m</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">kubevela-demo-app-web-v2   </span><span class="token number">0</span><span class="token plain">/0     </span><span class="token number">0</span><span class="token plain">            </span><span class="token number">0</span><span class="token plain">           0s</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">kubevela-demo-app-web-v2   </span><span class="token number">0</span><span class="token plain">/0     </span><span class="token number">0</span><span class="token plain">            </span><span class="token number">0</span><span class="token plain">           0s</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">kubevela-demo-app-web-v2   </span><span class="token number">0</span><span class="token plain">/0     </span><span class="token number">0</span><span class="token plain">            </span><span class="token number">0</span><span class="token plain">           0s</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">kubevela-demo-app-web-v1   </span><span class="token number">5</span><span class="token plain">/5     </span><span class="token number">5</span><span class="token plain">            </span><span class="token number">5</span><span class="token plain">           12m</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">kubevela-demo-app-web-v2   </span><span class="token number">0</span><span class="token plain">/0     </span><span class="token number">0</span><span class="token plain">            </span><span class="token number">0</span><span class="token plain">           0s</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">kubevela-demo-app-web-v2   </span><span class="token number">0</span><span class="token plain">/0     </span><span class="token number">0</span><span class="token plain">            </span><span class="token number">0</span><span class="token plain">           0s</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">kubevela-demo-app-web-v2   </span><span class="token number">0</span><span class="token plain">/0     </span><span class="token number">0</span><span class="token plain">            </span><span class="token number">0</span><span class="token plain">           0s</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">kubevela-demo-app-web-v2   </span><span class="token number">0</span><span class="token plain">/0     </span><span class="token number">0</span><span class="token plain">            </span><span class="token number">0</span><span class="token plain">           0s</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">kubevela-demo-app-web-v2   </span><span class="token number">0</span><span class="token plain">/2     </span><span class="token number">0</span><span class="token plain">            </span><span class="token number">0</span><span class="token plain">           0s</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">kubevela-demo-app-web-v2   </span><span class="token number">0</span><span class="token plain">/2     </span><span class="token number">0</span><span class="token plain">            </span><span class="token number">0</span><span class="token plain">           0s</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">kubevela-demo-app-web-v2   </span><span class="token number">0</span><span class="token plain">/2     </span><span class="token number">0</span><span class="token plain">            </span><span class="token number">0</span><span class="token plain">           0s</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">kubevela-demo-app-web-v2   </span><span class="token number">0</span><span class="token plain">/2     </span><span class="token number">2</span><span class="token plain">            </span><span class="token number">0</span><span class="token plain">           0s</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">kubevela-demo-app-web-v1   </span><span class="token number">5</span><span class="token plain">/5     </span><span class="token number">5</span><span class="token plain">            </span><span class="token number">5</span><span class="token plain">           12m</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">kubevela-demo-app-web-v2   </span><span class="token number">1</span><span class="token plain">/2     </span><span class="token number">2</span><span class="token plain">            </span><span class="token number">1</span><span class="token plain">           2s</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">kubevela-demo-app-web-v2   </span><span class="token number">2</span><span class="token plain">/2     </span><span class="token number">2</span><span class="token plain">            </span><span class="token number">2</span><span class="token plain">           2s</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">kubevela-demo-app-web-v1   </span><span class="token number">5</span><span class="token plain">/3     </span><span class="token number">5</span><span class="token plain">            </span><span class="token number">5</span><span class="token plain">           13m</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">kubevela-demo-app-web-v1   </span><span class="token number">5</span><span class="token plain">/3     </span><span class="token number">5</span><span class="token plain">            </span><span class="token number">5</span><span class="token plain">           13m</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">kubevela-demo-app-web-v1   </span><span class="token number">3</span><span class="token plain">/3     </span><span class="token number">3</span><span class="token plain">            </span><span class="token number">3</span><span class="token plain">           13m</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly bash"><div tabindex="0" class="prism-code language-bash codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token plain">$ </span><span class="token function" style="color:rgb(80, 250, 123)">curl</span><span class="token plain"> http://kubevela-demo-cicd-app.cf7c0ed25b151437ebe1ef58efc29bca4.us-west-1.alicontainer.com/</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">Version: </span><span class="token number">0.1</span><span class="token plain">.1</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">$ </span><span class="token function" style="color:rgb(80, 250, 123)">curl</span><span class="token plain"> http://kubevela-demo-cicd-app.cf7c0ed25b151437ebe1ef58efc29bca4.us-west-1.alicontainer.com/</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">Version: </span><span class="token number">0.1</span><span class="token plain">.1</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">$ </span><span class="token function" style="color:rgb(80, 250, 123)">curl</span><span class="token plain"> http://kubevela-demo-cicd-app.cf7c0ed25b151437ebe1ef58efc29bca4.us-west-1.alicontainer.com/</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">Version: </span><span class="token number">0.1</span><span class="token plain">.1</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">$ </span><span class="token function" style="color:rgb(80, 250, 123)">curl</span><span class="token plain"> http://kubevela-demo-cicd-app.cf7c0ed25b151437ebe1ef58efc29bca4.us-west-1.alicontainer.com/</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">Version: </span><span class="token number">0.1</span><span class="token plain">.1</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">$ </span><span class="token function" style="color:rgb(80, 250, 123)">curl</span><span class="token plain"> http://kubevela-demo-cicd-app.cf7c0ed25b151437ebe1ef58efc29bca4.us-west-1.alicontainer.com/</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">Version: </span><span class="token number">0.1</span><span class="token plain">.2</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">$ </span><span class="token function" style="color:rgb(80, 250, 123)">curl</span><span class="token plain"> http://kubevela-demo-cicd-app.cf7c0ed25b151437ebe1ef58efc29bca4.us-west-1.alicontainer.com/</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">Version: </span><span class="token number">0.1</span><span class="token plain">.2</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">$ </span><span class="token function" style="color:rgb(80, 250, 123)">curl</span><span class="token plain"> http://kubevela-demo-cicd-app.cf7c0ed25b151437ebe1ef58efc29bca4.us-west-1.alicontainer.com/</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">Version: </span><span class="token number">0.1</span><span class="token plain">.2</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">$ </span><span class="token function" style="color:rgb(80, 250, 123)">curl</span><span class="token plain"> http://kubevela-demo-cicd-app.cf7c0ed25b151437ebe1ef58efc29bca4.us-west-1.alicontainer.com/</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">Version: </span><span class="token number">0.1</span><span class="token plain">.2</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">$ </span><span class="token function" style="color:rgb(80, 250, 123)">curl</span><span class="token plain"> http://kubevela-demo-cicd-app.cf7c0ed25b151437ebe1ef58efc29bca4.us-west-1.alicontainer.com/</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">Version: </span><span class="token number">0.1</span><span class="token plain">.1</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>After confirming new services are functioning correctly, we can remove the <code>batchPartition: 0</code> as described above to complete the whole canary release process.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly bash"><div tabindex="0" class="prism-code language-bash codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token plain">$ kubectl get deployment -n kubevela-demo-namespace -w</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">NAME                       READY   UP-TO-DATE   AVAILABLE   AGE</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">kubevela-demo-app-web-v1   </span><span class="token number">3</span><span class="token plain">/3     </span><span class="token number">3</span><span class="token plain">            </span><span class="token number">3</span><span class="token plain">           18m</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">kubevela-demo-app-web-v2   </span><span class="token number">2</span><span class="token plain">/2     </span><span class="token number">2</span><span class="token plain">            </span><span class="token number">2</span><span class="token plain">           5m24s</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">kubevela-demo-app-web-v2   </span><span class="token number">2</span><span class="token plain">/5     </span><span class="token number">2</span><span class="token plain">            </span><span class="token number">2</span><span class="token plain">           5m36s</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">kubevela-demo-app-web-v2   </span><span class="token number">2</span><span class="token plain">/5     </span><span class="token number">2</span><span class="token plain">            </span><span class="token number">2</span><span class="token plain">           5m37s</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">kubevela-demo-app-web-v2   </span><span class="token number">2</span><span class="token plain">/5     </span><span class="token number">2</span><span class="token plain">            </span><span class="token number">2</span><span class="token plain">           5m37s</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">kubevela-demo-app-web-v2   </span><span class="token number">2</span><span class="token plain">/5     </span><span class="token number">5</span><span class="token plain">            </span><span class="token number">2</span><span class="token plain">           5m37s</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">kubevela-demo-app-web-v2   </span><span class="token number">3</span><span class="token plain">/5     </span><span class="token number">5</span><span class="token plain">            </span><span class="token number">3</span><span class="token plain">           5m38s</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">kubevela-demo-app-web-v2   </span><span class="token number">4</span><span class="token plain">/5     </span><span class="token number">5</span><span class="token plain">            </span><span class="token number">4</span><span class="token plain">           5m38s</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">kubevela-demo-app-web-v2   </span><span class="token number">5</span><span class="token plain">/5     </span><span class="token number">5</span><span class="token plain">            </span><span class="token number">5</span><span class="token plain">           5m39s</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">kubevela-demo-app-web-v1   </span><span class="token number">3</span><span class="token plain">/0     </span><span class="token number">3</span><span class="token plain">            </span><span class="token number">3</span><span class="token plain">           18m</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">kubevela-demo-app-web-v1   </span><span class="token number">3</span><span class="token plain">/0     </span><span class="token number">3</span><span class="token plain">            </span><span class="token number">3</span><span class="token plain">           18m</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">kubevela-demo-app-web-v1   </span><span class="token number">0</span><span class="token plain">/0     </span><span class="token number">0</span><span class="token plain">            </span><span class="token number">0</span><span class="token plain">           18m</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">kubevela-demo-app-web-v1   </span><span class="token number">0</span><span class="token plain">/0     </span><span class="token number">0</span><span class="token plain">            </span><span class="token number">0</span><span class="token plain">           18m</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">kubevela-demo-app-web-v2   </span><span class="token number">5</span><span class="token plain">/5     </span><span class="token number">5</span><span class="token plain">            </span><span class="token number">5</span><span class="token plain">           5m41s</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">kubevela-demo-app-web-v2   </span><span class="token number">5</span><span class="token plain">/5     </span><span class="token number">5</span><span class="token plain">            </span><span class="token number">5</span><span class="token plain">           5m41s</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">kubevela-demo-app-web-v1   </span><span class="token number">0</span><span class="token plain">/0     </span><span class="token number">0</span><span class="token plain">            </span><span class="token number">0</span><span class="token plain">           18m</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="conclusion"></a>Conclusion<a class="hash-link" href="#conclusion" title="Direct link to heading">#</a></h2><p>In summary, we executed the whole continuous delivery process successfully. In this process, developers can easily update and deploy their applications, with the help of KubeVela and Jenkins. Besides, developers can use their favourite tools in different stages, such as substituting GitHub with Gitlab, or using TravisCI instead of Jenkins.</p><p>Readers might also notice that this progress can not only upgrade the application service, but also change deployment plan via editing <code>app.yaml</code>, such as scaling up or adding sidecars, which works like classical push-style GitOps. About more KubeVela GitOps content, you can refer to other related case studies.</p></div><footer class="row margin-vert--lg"><div class="col"><strong>Tags:</strong><a class="margin-horiz--sm" href="/blog/tags/kube-vela">KubeVela</a></div></footer></article><article class="margin-bottom--xl"><header><h2 class="margin-bottom--sm blogPostTitle_GeHD"><a href="/blog/2021/08/30/kubevela-performance-test">KubeVela Performance Test - Managing Massive Applications</a></h2><div class="margin-vert--md"><time datetime="2021-08-30T00:00:00.000Z" class="blogPostDate_fNvV">August 30, 2021 Â· 9 min read</time></div><div class="avatar margin-vert--md"><a href="https://github.com/oam-dev/kubevela" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img src="https://kubevela.io/img/logo.svg" alt="Da Yin, Yang Song, Zhengxi Zhou and Jianbo Sun"></a><div class="avatar__intro"><h4 class="avatar__name"><a href="https://github.com/oam-dev/kubevela" target="_blank" rel="noopener noreferrer">Da Yin, Yang Song, Zhengxi Zhou and Jianbo Sun</a></h4><small class="avatar__subtitle">KubeVela Team</small></div></div></header><div class="markdown"><p>As an application management and integration platform, KubeVela needs to handle thousands of applications in production scenario. To evaluate the performance of KubeVela, develop team has conducted performance tests based on simultated environments and demonstrated the capability of managing a large number of applications concurrently.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="setup"></a>Setup<a class="hash-link" href="#setup" title="Direct link to heading">#</a></h2><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="cluster-environment"></a>Cluster Environment<a class="hash-link" href="#cluster-environment" title="Direct link to heading">#</a></h3><p>Working with large clusters requires lots of resources, such as Machines, Network Bandwidth, Storages and many other devices. Therefore, KubeVela team adopts kubemark, an official tool provided by kubernetes, to simulate large clusters by mocking hundreds of kubelets. Each kubelet works like a real node except that they do not run real containers inside pods. The aim of KubeVela performance test mainly focus on whether KubeVela controller can manage thousands of applications effectively, instead of pulling images or executing commands inside pods. As a result, we only need to get resources hosting these fake nodes, also named as hollow-nodes.</p><p>We set up the Kubernetes clusters on Alibaba Cloud which includes 5 master nodes and 15 worker nodes. The master nodes wil host Kubernetes core components such as kube-apiserver and kube-controller-manager. The worker nodes need to run other pressure-test related componets, including monitoring tools, KubeVela controller and kubemark pods. Since the major target is to test the performance of KubeVela controller, we do not expect other components to be the bottleneck of the pressure test. To this end, both master nodes and worker nodes are equiped with 32 cores and 128 Gi memory. We use the combination of Prometheus, Loki and Grafana as the monitoring suites and grant them enough resources in avoid of crash caused by Out-of-Memory.</p><p>Notice that KubeVela controller and monitoring tools need to be placed on real nodes to function while all pods created during performance tests should be assigned to hollow-nodes correctly. To achieve that, we give different taints to hollow-nodes and real nodes, and add corresponding tolerations to different pods.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="application"></a>Application<a class="hash-link" href="#application" title="Direct link to heading">#</a></h3><p>To simulate real applications in production, we design an application template with 2 components and 5 functional traits, including</p><ul><li>1 webservice component<ul><li>a scaler trait setting its replica to 3</li><li>a sidecar trait attaching another container to each pod</li><li>an ingress trait generating one ingress instance and one service instance</li></ul></li><li>1 worker component<ul><li>a scaler trait also setting its replica to 3</li><li>a configmap trait generating a new configmap and attaching it to worker pods</li></ul></li></ul><p>In the following experiment, we test the performance of KubeVela controller managing 3,000 Applications (12,000 Pods in total) on 200 nodes. Applications are created in parallel at first, then kept running for a while, and finally deleted from the cluster. Each application will be reconciled multiple times with latencies and consumed resources recorded by monitoring tools.</p><blockquote><p>In practice, we also have another trait used for adding tolerations as described above.</p></blockquote><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="kubevela-controller"></a>KubeVela Controller<a class="hash-link" href="#kubevela-controller" title="Direct link to heading">#</a></h3><p>The KubeVela controller is set up with a group of recommendation configurations as follows</p><ul><li>Kubernetes Resource<ul><li>0.5 core CPU</li><li>1 Gi Memory</li><li>1 replica</li></ul></li><li>Program <ul><li>concurrent-reconciles=2 (The number of reconcile threads)</li><li>kube-api-qps=300 (The qps of kubernetes client used in controller)</li><li>kube-api-burst=500 (The burst of kubernetes client used in controller)</li><li>informer-re-sync-interval=20m (The interval of routine reconciles.)
We will analyze these settings in the below sections.</li></ul></li></ul><blockquote><p>To evaluate the performance of KubeVela Controller itself, we disabled the Ingress MutatingWebhook and Application ValidatingWebhook which is beyond the focus of this test but will affect the performance of KubeVela Controller by increasing the latency of creating/patching resources.</p></blockquote><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="experiments"></a>Experiments<a class="hash-link" href="#experiments" title="Direct link to heading">#</a></h2><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="creation"></a>Creation<a class="hash-link" href="#creation" title="Direct link to heading">#</a></h3><p>The creation of all 3,000 applications lasted 25min. Getting all pods running takes a bit longer time, which is out of the scope of KubeVela controller. </p><p>For each application creation, it will trigger three turns of reconciling. The usage of CPU will reach 100% in the late period of creation. The memory usage will increase as the number of applications rises. It reaches around 67% at the end of creation.</p><p><img alt="create-cpu" src="/assets/images/create-cpu-50a2f951ca18219c47f86fc87861387a.png">
<img alt="create-memory" src="/assets/images/create-memory-1d5a108aa88dca5b5233df07b975869f.png"></p><p>The average time of the first turn reconciling is relatively short since it only needs patch finalizer. The second and third turn reconciling contain full reconcile cycles and need more time to process. The following charts record the time consumptions of different period during reconciling applications. The average time is generally below 200ms while 99% of reconciles uses less than 800ms.</p><p><img alt="create-avg-time" src="/assets/images/create-avg-time-c9096f848bacebb15879e354db90ad79.png">
<img alt="create-p99-time" src="/assets/images/create-p99-time-6834848739195ef1a6836e8830a60940.png"></p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="regular-reconciles"></a>Regular Reconciles<a class="hash-link" href="#regular-reconciles" title="Direct link to heading">#</a></h3><p>After creation, applications are reconciled by controller every 20min. the monitoring of 8-hour reconcile process are displayed as below. The CPU usage will come up to 90% once reconcile happens routinely. The memory usage generally keeps a stable pattern, up to 75% memory usage.</p><p><img alt="med-cpu" src="/assets/images/med-cpu-1ee6beebe2ddac70499b2fe0f1200346.png">
<img alt="med-memory" src="/assets/images/med-memory-84ee70599fdfe10c539d31a8ffd011f3.png"></p><p>The average reconcile time is under 200ms while 99% are about 800ms~900ms. Each regular reconcile for all applications generally takes around 10min.</p><p><img alt="med-avg" src="/assets/images/med-avg-71e81f42a57ba18fe977c1cb8f041e6f.png">
<img alt="med-p99" src="/assets/images/med-p99-660473173a37679faf8f5c54a4668b7c.png"></p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="deletion"></a>Deletion<a class="hash-link" href="#deletion" title="Direct link to heading">#</a></h3><p>The application deletion process is fast and low-resource consumptive. It takes less than 3min to delete all applications. However, notice that the deletion of resources managed by application usually takes longer time. This is because the cleanup of these resources (such as deployments or pods) are not directly controlled by the KubeVela controller. KubeVela controller takes charge of deleting their owner and cleanup them by triggering cascading deletion. In addition, each deletion is associated with two turns of reconcile where the second turn returns immediately when it fails to retrieve target applciation (since it is deleted).</p><p><img alt="del-cpu" src="/assets/images/del-cpu-e20c033c8d55123b17d4daf25af8b0e1.png">
<img alt="del-memory" src="/assets/images/del-memory-7185fe1f634f7bfede12924608db96f2.png">
<img alt="del-avg" src="/assets/images/del-avg-b8c9b19de6d6472f5ad751ee5b13cd22.png">
<img alt="del-p99" src="/assets/images/del-p99-c2efbbd508a210d006bbb511944ec547.png"></p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="analysis"></a>Analysis<a class="hash-link" href="#analysis" title="Direct link to heading">#</a></h2><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="number-of-applications"></a>Number of Applications<a class="hash-link" href="#number-of-applications" title="Direct link to heading">#</a></h3><p>The experiment displayed above demonstrates a classical scenario for KubeVela. Although 3,000 applications are successfully managed by the KubeVela controller in this case, it is strongly recommended to adopt a smaller number (such as 2,000) of applications with the above configuration for the following reasons:
The time and resource consumption is closely associated with the spec of applications. If a lot of users apply larger applications with more pods and more other resources, 3,000 applications might break the resource limit more easily.
The memory and CPU usage shown above is approching resource limits. If memory drains, the KubeVela controller will crash and restart. If high CPU usage maintains for a long time, it might cause a long waiting queue in KubeVela controller which further lead to longer response time for application changes.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="configurations"></a>Configurations<a class="hash-link" href="#configurations" title="Direct link to heading">#</a></h3><p>There are several parameters users could config to adapt into their own scenario.
Using more replica for KubeVela controller do not scale up the ability of KubeVela controller. The leader election mechanism ensures that only one replica will work while others will wait. The aim of multi-replica is to support fast recovery when the working one crash. However, if the crash is caused by OOM, the recovery usually will not be able to fix that.
The number of qps and burst in the program configuration should be increased accordingly while scaling up KubeVela controller. These two parameters limit the capability for controller to send requests to apiserver.
Generally, in order to scale up KubeVela controller, scale up the resource limits and all the program parameters mentioned above (except the reconcile interval). If you have more applications to manage, add more memory. If you have higher operation frequency, add more CPU and threads, then increase qps and burst accordingly.
Longer reconcile interval allows more applications to handle, at the cost of longer time to fix potential underlying resource problems. For example, if one deployment managed by one application disappears, the routine reconciling can discover this problem and fix it.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="scaling-up"></a>Scaling Up<a class="hash-link" href="#scaling-up" title="Direct link to heading">#</a></h3><p>In addition to the experiment described above, we conducted another two experiment to test how well KubeVela controller can scale to larger clusters and more applications.</p><p>In a 500-node cluster, we tried to create 5,000 applications with the same spec described above, at the speed of 4 per second and lasted for around 21min. 1 core and 2 Gi memory are granted to KubeVela controller with the use of 4 concurrent reconcile threads. The kube-api-qps and kube-api-burst are raised to 500/800 correspondingly. All 30,000 pods successfully turn into Running phase. The time costs for each reconcile is similar to the previous experiment and CPU/Memory cost is not very high compared to the given resources. The regular reconciles for 5,000 applications takes 7~8 minutes, and no significant resource cost is observed. During this scaling, we found that the throughput of kube-apiserver starts to block the creation of application, as too many resources need to be created while applying applications.</p><p><img alt="std-cpu" src="/assets/images/std-cpu-ffd81b9aa9f3f19744fe28d7f9817e73.png">
<img alt="std-memory" src="/assets/images/std-memory-d0fb9771e7ab4d9588ef193424a76073.png"></p><p>Scaling up to 12,000 applications on 1,000 nodes is much harder than previous attempts. With the same creation speed, the apiserver will be flooded by lots of pod scheduling requests and finally start to drop application creation request. To overcome this difficulty, we divide the creation process of applications into several stage. Each stage only create 1,000~3,000 applications and the next stage will not begin until all pods are ready. With this strategy, we successfully create 12,000 applications, 24,000 deployments, 12,000 services, 12,000 ingress, 12,000 configmaps and 72,000 pods. The whole process takes about 30 hours. To hold this number of applications, KubeVela controller consumes 1.7 cores and 2.45 Gi memory. It takes about 12min to finish a full turn of regular reconciles for all 12,000 applications.</p><p><img alt="large-cpu" src="/assets/images/large-cpu-d83276edbb15f8a396f27ea144625469.png">
<img alt="large-memory" src="/assets/images/large-memory-360f435a8446f13a86246c19fad2f729.png">
<img alt="large-all" src="/assets/images/large-all-8b83d8c79d4faf56ba67aa9594ce5eee.png"></p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="future"></a>Future<a class="hash-link" href="#future" title="Direct link to heading">#</a></h3><p>The performance test of KubeVela demonstrates its ability of managing thousands of applications with limited resource consumption. It can also scale up to over 10,000 applications on large clusters with 1,000 nodes. In addition, KubeVela team also conducted similar pressure test for non-deployment based applications such as CloneSet in OpenKruise (which is not enclosed in this report) and reach same conclusions. In the future, we will add more performance tests for more complex scenario like Workflow or MultiCluster.</p></div><footer class="row margin-vert--lg"><div class="col"><strong>Tags:</strong><a class="margin-horiz--sm" href="/blog/tags/kube-vela">KubeVela</a></div></footer></article><article class="margin-bottom--xl"><header><h2 class="margin-bottom--sm blogPostTitle_GeHD"><a href="/blog/2020/12/07/kubevela-the-extensible-app-platform-based-on-open-application-model-and-kubernetes">KubeVela - The Extensible App Platform Based on Open Application Model and Kubernetes</a></h2><div class="margin-vert--md"><time datetime="2020-12-07T00:00:00.000Z" class="blogPostDate_fNvV">December 7, 2020 Â· 8 min read</time></div><div class="avatar margin-vert--md"><a href="https://github.com/JoelMarcey" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img src="https://avatars.githubusercontent.com/u/1701782?s=200&amp;v=4" alt="Lei Zhang and Fei Guo"></a><div class="avatar__intro"><h4 class="avatar__name"><a href="https://github.com/JoelMarcey" target="_blank" rel="noopener noreferrer">Lei Zhang and Fei Guo</a></h4><small class="avatar__subtitle">CNCF TOC Member/Kubernetes</small></div></div></header><div class="markdown"><blockquote><p>7 Dec 2020 12:33pm, by Lei Zhang and Fei Guo</p></blockquote><p><img src="https://tva1.sinaimg.cn/large/ad5fbf65gy1glgj5q8inej208g049aa6.jpg" alt="image"></p><p>Last month at KubeCon+CloudNativeCon 2020, the <a href="https://github.com/oam-dev/spec" target="_blank" rel="noopener noreferrer">Open Application Model (OAM)</a> community launched <a href="https://github.com/oam-dev/kubevela/" target="_blank" rel="noopener noreferrer">KubeVela</a>, an easy-to-use yet highly extensible application platform based on OAM and Kubernetes.</p><p>For developers, KubeVela is an easy-to-use tool that enables you to describe and ship applications to Kubernetes with minimal effort, yet for platform builders, KubeVela serves as a framework that empowers them to create developer-facing yet fully extensible platforms at ease.</p><p>The trend of cloud native technology is moving towards pursuing consistent application delivery across clouds and on-premises infrastructures using Kubernetes as the common abstraction layer. Kubernetes, although excellent in abstracting low-level infrastructure details, does introduce extra complexity to application developers, namely understanding the concepts of pods, port exposing, privilege escalation, resource claims, CRD, and so on. Weâ€™ve seen the nontrivial learning curve and the lack of developer-facing abstraction have impacted user experiences, slowed down productivity, led to unexpected errors or misconfigurations in production.</p><p>Abstracting Kubernetes to serve developersâ€™ requirements is a highly opinionated process, and the resultant abstractions would only make sense had the decision-makers been the platform builders. Unfortunately, the platform builders today face the following dilemma: There is no tool or framework for them to easily extend the abstractions if any.</p><p>Thus, many platforms today introduce restricted abstractions and add-on mechanisms despite the extensibility of Kubernetes. This makes easily extending such platforms for developersâ€™ requirements or to wider scenarios almost impossible.</p><p>In the end, developers complain those platforms are too rigid and slow in response to feature requests or improvements. The platform builders do want to help but the engineering effort is daunting: any simple API change in the platform could easily become a marathon negotiation around the opinionated abstraction design.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="introducing-kubevela"></a>Introducing KubeVela<a class="hash-link" href="#introducing-kubevela" title="Direct link to heading">#</a></h2><p>With KubeVela, we aim to solve these two challenges in an approach that separates concerns of developers and platform builders.</p><p>For developers, KubeVela is an easy-to-use yet extensible tool that enables you to describe and deploy microservices applications with minimal effort. And instead of managing a handful of Kubernetes YAML files, a simple docker-compose style <code>appfile</code> is all you need.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="a-sample-appfile"></a>A Sample Appfile<a class="hash-link" href="#a-sample-appfile" title="Direct link to heading">#</a></h3><p>In this example, we will create a vela.yaml along with your app. This file describes how to build the image, how to deploy the image to Kubernetes, how to access the application and how the system would scale it automatically.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly yaml"><div tabindex="0" class="prism-code language-yaml codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> testapp</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token key atrule">services</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">express-server</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">image</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> oamdev/testapp</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain">v1</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">build</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token key atrule">docker</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token key atrule">file</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> Dockerfile</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token key atrule">contrxt</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> .</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">cmd</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token string" style="color:rgb(255, 121, 198)">&quot;node&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;server.js&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">port</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token number">8080</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">cpu</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;0.01&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">route</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token key atrule">domain</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> example.com</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token key atrule">rules</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">path</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> /testapp</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token key atrule">rewriteTarget</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> /</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">autoscale</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token key atrule">min</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token number">1</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token key atrule">max</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token number">4</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token key atrule">cpuPercent</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token number">5</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>Just do: <code>$ vela up</code>, your app will then be alive on  <a href="https://example.com/testapp" target="_blank" rel="noopener noreferrer">https://example.com/testapp</a>.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="behind-the-appfile"></a>Behind the Appfile<a class="hash-link" href="#behind-the-appfile" title="Direct link to heading">#</a></h3><p>The <code>appfile</code> in KubeVela does not have a fixed schema specification, instead, what you can define in this file is determined by what kind of workload types and traits are available in your platform. These two concepts are core concepts from OAM, in detail:</p><ul><li><a href="https://kubevela.io/%23/en/concepts?id=workload-type-amp-trait" target="_blank" rel="noopener noreferrer">Workload type</a>, which declares the characteristics that runtime infrastructure should take into account in application deployment. In the sample above, it defines a â€œWeb Serviceâ€ workload named <code>express-server</code> as part of your application.</li><li><a href="https://kubevela.io/%23/en/concepts?id=workload-type-amp-trait" target="_blank" rel="noopener noreferrer">Trait</a>, which represents the operation configurations that are attached to an instance of workload type. Traits augment a workload type instance with operational features. In the sample above, it defines a route trait to access the application and an autoscale trait for the CPU based horizontal automatic scaling policy.</li></ul><p>Whenever a new workload type or trait is added, it would become immediately available to be declared in the <code>appfile</code>. Letâ€™s say, a new trait named metrics is added, developers could check the schema of this trait by simply <code>$ vela show metrics</code> and define it in the previous sample <code>appfile</code>:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly yaml"><div tabindex="0" class="prism-code language-yaml codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> testapp</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token key atrule">services</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">express-server</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">type</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> webservice</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">image</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> oamdev/testapp</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain">v1</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">build</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token key atrule">docker</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token key atrule">file</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> Dockerfile</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token key atrule">contrxt</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> .</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">cmd</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token string" style="color:rgb(255, 121, 198)">&quot;node&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;server.js&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">port</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token number">8080</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">cpu</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;0.01&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">route</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token key atrule">domain</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> example.com</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token key atrule">rules</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">path</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> /testapp</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token key atrule">rewriteTarget</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> /</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">autoscale</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token key atrule">min</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token number">1</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token key atrule">max</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token number">4</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token key atrule">cpuPercent</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token number">5</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">metrices</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token key atrule">port</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token number">8080</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token key atrule">path</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;/metrics&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token key atrule">scheme</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;http&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token key atrule">enabled</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token boolean important">true</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="vela-up"></a>Vela Up<a class="hash-link" href="#vela-up" title="Direct link to heading">#</a></h2><p>The <code>vela up</code> command deploys the application defined in <code>appfile</code> to Kubernetes. After deployment, you can use <code>vela status</code> to check how to access your application following the <code>route</code> trait declared in <code>appfile</code>.</p><p><img src="https://tvax2.sinaimg.cn/large/ad5fbf65gy1glf9pyhr42j20la0kiafn.jpg"></p><p>Apps deployed with KubeVela will receive a URL (and versioned pre-release URLs) with valid TLS certificate automatically generated via <a href="https://cert-manager.io/docs/" target="_blank" rel="noopener noreferrer">cert-manager</a>. KubeVela also provides a set of commands (i.e. <code>vela logs, vela exec</code>) to best support your application management without becoming a Kubernetes expert. <a href="https://kubevela.io/%23/en/developers/learn-appfile" target="_blank" rel="noopener noreferrer">Learn more about vela up and appfile</a>.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="kubevela-for-platform-builders"></a>KubeVela for Platform Builders<a class="hash-link" href="#kubevela-for-platform-builders" title="Direct link to heading">#</a></h2><p>The above experience cannot be achieved without KubeVelaâ€™s innovative offerings to the platform builders as an extensible platform engine. These features are the hidden gems that make KubeVela unique. In details, KubeVela relieves the pains of building developer facing platforms on Kubernetes by doing the following:</p><ul><li><strong>Application Centric</strong>. Behind the appfile, KubeVela enforces â€œapplicationâ€ as its main API and all KubeVelaâ€™s capabilities serve the applicationsâ€™ requirements only. This is how KubeVela brings application-centric context to the platform by default and changes building such platforms into working around application architecture.</li><li><strong>Extending Natively</strong>. As mentioned in the developer section, an application described by appfile is composed of various pluggable workload types and operation features (i.e. traits). Capabilities from Kubernetes ecosystem can be added to KubeVela as new workload types or traits through Kubernetes CRD registry mechanism at any time.</li><li><strong>Simple yet Extensible User Interface</strong>. Behind the <code>appfile</code>, KubeVela uses <a href="https://github.com/cuelang/cue" target="_blank" rel="noopener noreferrer">CUELang</a> as the â€œlast mileâ€ abstraction engine between user-facing schema and the control plane objects. KubeVela provides a set of built-in abstractions to start with and the platform builders are free to modify them at any time. Capability adding/updating or abstraction changes will all take effect at runtime, neither recompilation nor redeployment of KubeVela is required.</li></ul><p>Under the hood, KubeVela core is built on top of Crossplane OAM Kubernetes Runtime with KEDA, Flagger, Prometheus, etc as dependencies, yet its feature pool is â€œunlimitedâ€ and can be extended at any time.</p><p><img src="https://tva2.sinaimg.cn/large/ad5fbf65gy1glf9sktkdxj20q00dsacl.jpg"></p><p>With KubeVela, platform builders now have the tooling support to design and ship any new capabilities with abstractions to end-users with high confidence and low turnaround time. And for a developer, you only need to learn these abstractions, describe the app with them in a single file, and then ship it.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="not-another-paas-system"></a>Not Another PaaS System<a class="hash-link" href="#not-another-paas-system" title="Direct link to heading">#</a></h2><p>Most typical Platform-as-a-Service (PaaS) systems also provide full application management capabilities and aim to improve developer experience and efficiency. In this context, KubeVela shares the same goal.</p><p>Though unlike most typical PaaS systems which are either inextensible or create their own addon systems maintained by their own communities. KubeVela is designed to fully leverage the Kubernetes ecosystems as its capability pool. Hence, thereâ€™s no additional addon system introduced in this project. For platform builders, a new capability can be installed in KubeVela at any time by simply registering its API resource to OAM and providing a CUE template. We hope and expect that with the help of the open source community, the number of the KubeVelaâ€™s capabilities will grow dramatically over time. <a href="https://kubevela.io/%23/en/developers/cap-center" target="_blank" rel="noopener noreferrer">Learn more about using community capabilities by $vela cap</a>.</p><p>So in a nutshell, KubeVela is a Kubernetes plugin for building application-centric abstractions. It leverages the native Kubernetes extensibility and capabilities to resolve a hard problem â€“ making application management enjoyable on Kubernetes.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="learn-more"></a>Learn More<a class="hash-link" href="#learn-more" title="Direct link to heading">#</a></h2><p>KubeVela is incubated by the OAM community as the successor of <a href="https://github.com/oam-dev/rudr" target="_blank" rel="noopener noreferrer">Rudr</a> project, while rather than being a reference implementation, KubeVela intends to be an end-to-end implementation that could be used in wider scenarios. The design of KubeVelaâ€™s appfile is also part of the experimental attempt in OAM specification to bring a simplified user experience to developers.</p><p>To learn more about KubeVela, please visit KubeVelaâ€™s <a href="https://kubevela.io/" target="_blank" rel="noopener noreferrer">documentation site</a>. The following content are also good next steps:</p><ul><li>Try out KubeVela following the <a href="https://kubevela.io/%23/en/quick-start" target="_blank" rel="noopener noreferrer">step-by-step tutorial</a> in its Quick Start page.</li><li>Give us feedback! KubeVela is still in its early stage and we are happy to ask the community for feedback via OAM <a href="https://gitter.im/oam-dev/community" target="_blank" rel="noopener noreferrer">Gitter</a> or <a href="https://cloud-native.slack.com/archives/C01BLQ3HTJA" target="_blank" rel="noopener noreferrer">Slack channel</a>.</li><li><a href="https://kubevela.io/%23/en/platform-engineers/trait" target="_blank" rel="noopener noreferrer">Extend KubeVela</a> to build your own platforms. If you have an idea for a new workload type, trait or try to build something more complex like a database or AI PaaS with KubeVela, post your idea as a GitHub Issue or propose it to the OAM community, we are eager to know.</li><li><a href="https://github.com/oam-dev/kubevela/blob/master/CONTRIBUTING.md" target="_blank" rel="noopener noreferrer">Contribute to KubeVela</a>. KubeVela is initialized by the open source community with <a href="https://github.com/oam-dev/kubevela/blob/bbb2c527d96d3e1a0694e2f49b3d1d1168e72c53/OWNERS_ALIASES%23L35" target="_blank" rel="noopener noreferrer">bootstrap contributors</a> from 8+ different organizations. We intend to donate this project to a neutral foundation as soon as it gets stable.</li></ul></div><footer class="row margin-vert--lg"><div class="col"><strong>Tags:</strong><a class="margin-horiz--sm" href="/blog/tags/kube-vela">KubeVela</a></div></footer></article><nav class="pagination-nav" aria-label="Blog list page navigation"><div class="pagination-nav__item"></div><div class="pagination-nav__item pagination-nav__item--next"></div></nav></main></div></div></div><footer class="footer"><div class="container"><div class="row footer__links"><div class="col footer__col"><h4 class="footer__title">Documentation</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/docs/end-user/quick-start-cli">Getting Started</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/tutorials/webservice">Tutorials</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/platform-engineers/oam/oam-model">Extension</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">Community</h4><ul class="footer__items"><li class="footer__item"><a href="https://slack.cncf.io/" target="_blank" rel="noopener noreferrer" class="footer__link-item">CNCF Slack ( #kubevela channel )</a></li><li class="footer__item"><a href="https://gitter.im/oam-dev/community" target="_blank" rel="noopener noreferrer" class="footer__link-item">Gitter</a></li><li class="footer__item"><a class="footer__link-item" href="/">DingTalk (23310022)</a></li><li class="footer__item"><div class="wechat"> <a class="wechat-label">Wechat Group(Scan code to request joining)</a> <a class="wechat-img" rel="noreferrer noopener" aria-label="Wechat Group"><img src="https://static.kubevela.net/images/barnett-wechat.jpg" alt="Broker wechat to add you into the user group."></a></div></li></ul></div><div class="col footer__col"><h4 class="footer__title">More</h4><ul class="footer__items"><li class="footer__item"><a href="https://github.com/oam-dev/kubevela" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub</a></li><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">
        <br>
        <strong>Â© KubeVela Authors 2022 | Documentation Distributed under <a href="https://creativecommons.org/licenses/by/4.0">CC-BY-4.0</a> </strong> <strong>| Powered by <a href="https://www.netlify.com">Netlify</a></strong>
        <br>
        <br>
        Â© 2022 The Linux Foundation. All rights reserved. The Linux Foundation has registered trademarks and uses trademarks. For a list of trademarks of The Linux Foundation, please see our <a href="https://www.linuxfoundation.org/trademark-usage/"> Trademark Usage</a> page. <a href="https://beian.miit.gov.cn/" target="_blank">æµ™ICPå¤‡12022327å·</a>
      </div></div></div></footer></div>
<script src="/assets/js/runtime~main.95f7c22f.js"></script>
<script src="/assets/js/main.a6060325.js"></script>
</body>
</html>