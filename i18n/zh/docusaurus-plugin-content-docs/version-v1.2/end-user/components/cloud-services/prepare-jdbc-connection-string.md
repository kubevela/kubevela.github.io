---
title: 生成 JDBC 连接字符串
---

使用 JDBC 连接字符串来连接数据库是很常见的。本文档将重点介绍如何生成 JDBC 连接字符串 以及如何在应用中使用它。

## 如何为业务组件生成 JDBC 连接串

- 提交工作流步骤 `generate-jdbc-connection`

> 工作流步骤 `generate-jdbc-connection` 将随着 KubeVela 的安装自动安装。正式发布后，无需手动操作。

```shell
$ vela def apply generate-jdbc-connection.cue
```

```
# generate-jdbc-connection.cue
import (
	"vela/op"
	"encoding/base64"
)

"generate-jdbc-connection": {
	type: "workflow-step"
	annotations: {}
	labels: {
		"ui-hidden": "true"
	}
	description: "Generate a JDBC connection based on Component of alibaba-rds"
}
template: {
	output: op.#Read & {
		value: {
			apiVersion: "v1"
			kind:       "Secret"
			metadata: {
				name: parameter.name
				if parameter.namespace != _|_ {
					namespace: parameter.namespace
				}
			}
		}
	}
	dbHost:   op.#ConvertString & {bt: base64.Decode(null, output.value.data["DB_HOST"])}
	dbPort:   op.#ConvertString & {bt: base64.Decode(null, output.value.data["DB_PORT"])}
	dbName:   op.#ConvertString & {bt: base64.Decode(null, output.value.data["DB_NAME"])}
	username: op.#ConvertString & {bt: base64.Decode(null, output.value.data["DB_USER"])}
	password: op.#ConvertString & {bt: base64.Decode(null, output.value.data["DB_PASSWORD"])}

	env: [
		{name: "url", value:      "jdbc://" + dbHost.str + ":" + dbPort.str + "/" + dbName.str + "?characterEncoding=utf8&useSSL=false"},
		{name: "username", value: username.str},
		{name: "password", value: password.str},
	]

	parameter: {
		// +usage=Specify the name of the secret generated by database component
		name: string
		// +usage=Specify the namespace of the secret generated by database component
		namespace?: string
	}
}

```

属性 `namespace` 和 `name` 指的是数据库组件生成的 Secret 的命名空间和名称。

```
$ vela show generate-jdbc-connection
# Properties
+-----------+---------------------------------------------------------------------+--------+----------+---------+
|   NAME    |                             DESCRIPTION                             |  TYPE  | REQUIRED | DEFAULT |
+-----------+---------------------------------------------------------------------+--------+----------+---------+
| name      | Specify the name of the secret generated by database component      | string | true     |         |
| namespace | Specify the namespace of the secret generated by database component | string | false    |         |
+-----------+---------------------------------------------------------------------+--------+----------+---------+
```

[Secret 数据的 key 列表]((./terraform/alibaba-rds#outputs)) 如下:

| Name                | Description                    |
|---------------------|--------------------------------|
| DB_NAME             | RDS Instance Name              |
| DB_USER             | RDS Instance User              |
| DB_HOST             | RDS Instance Host              |
| DB_PASSWORD         | RDS Instance Password          |
| DB_PORT             | RDS Instance Port              |
| DATABASE_NAME       | RDS Database Name              |

> 如果数据库组件生成的 Secret Key 与上述不同，工作流程将无法运行。

- 提交应用使用 JDBC 连接串

```shell
apiVersion: core.oam.dev/v1beta1
kind: Application
metadata:
  name: jdbc
spec:
  components:
    - name: db
      type: alibaba-rds
      properties:
        instance_name: favorite-links
        database_name: db1
        account_name: oamtest
        password: U34rfwefwefffaked
        security_ips: [ "0.0.0.0/0" ]
        privilege: ReadWrite
        writeConnectionSecretToRef:
          name: db-conn
  - name: express-server
    type: webservice
    properties:
      image: crccheck/hello-world
      port: 8000
      
  workflow:
    steps:
    - name: jdbc
      type: generate-jdbc-connection
      outputs:
        - name: jdbc
          valueFrom: jdbc
      properties:
        name: db-conn
        namespace: default
    - name: apply
      type: apply-component
      inputs:
        - from: jdbc
          parameterKey: env
      properties:
        component: express-server

```

提交上面的应用，检查组件 `express-server` 的环境变量是否成功设置。

```shell
$ kubectl get deploy express-server -o yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: express-server
  namespace: default
  resourceVersion: "67119228"
  uid: 228493b2-7ee7-4147-91f6-b7b23bc78c3b
spec:
  ...
  template:
    metadata:
      creationTimestamp: null
      labels:
        app.oam.dev/component: express-server
        app.oam.dev/revision: express-server-v2
    spec:
      containers:
      - env:
        - name: jdbc
          value: jdbc://rm-xxxx.mysql.rds.aliyuncs.com:3306/db1?characterEncoding=utf8&useSSL=false
        - name: username
          value: oamtest
        - name: password
          value: U34rfwefwefffaked
        image: crccheck/hello-world
```

我们可以看到，组件 `express-server` 的环境变量已经成功设置了 JDBC JDBC连接串。
